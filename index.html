<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Biblioteca Pessoal</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root { --bg-color:#f8fafc; --text-color:#1f2937; --nav-bg:#4f46e5; --card-bg:white; --card-shadow:rgba(0,0,0,0.08); --progress-bg:#e5e7eb; --progress-fill:#4f46e5; }
    [data-theme="dark"] { --bg-color:#0f172a; --text-color:#f1f5f9; --nav-bg:#312e81; --card-bg:#1e293b; --card-shadow:rgba(0,0,0,0.4); --progress-bg:#374151; --progress-fill:#6366f1; }
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins','Segoe UI',sans-serif; }
    body { display:grid; grid-template-columns:240px 1fr; height:100vh; background:var(--bg-color); color:var(--text-color); }
    nav { background:var(--nav-bg); padding:1rem; color:white; display:flex; flex-direction:column; gap:0.25rem; }
    nav h2 { font-size:1.2rem; margin-bottom:1rem; }
    nav button { width:100%; background:transparent; border:none; color:inherit; padding:0.6rem 0.8rem; text-align:left; cursor:pointer; border-radius:0.375rem; transition:background 0.3s, transform 0.2s; display:flex; align-items:center; gap:0.5rem; }
    nav button:hover { background:rgba(255,255,255,0.15); transform:translateX(4px); }
    nav button.active { background:rgba(255,255,255,0.3); }
    main { padding:1rem; overflow-y:auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); padding:0.5rem 1rem; border-radius:0.5rem; box-shadow:0 2px 8px var(--card-shadow); margin-bottom:1rem; }
    header h1 { font-size:1.2rem; }
    .card { background:var(--card-bg); padding:1rem; border-radius:0.5rem; box-shadow:0 4px 12px var(--card-shadow); margin-bottom:1rem; cursor:default; }
    .progress-bar { background:var(--progress-bg); height:8px; border-radius:4px; overflow:hidden; margin:0.25rem 0; }
    .progress-fill { height:100%; background:var(--progress-fill); width:0%; }
    .update-btn { background:#e0e0e0; color:var(--text-color); border:none; border-radius:0.25rem; padding:0.4rem 0.6rem; font-size:0.85rem; cursor:pointer; margin-top:0.5rem; width:150px; white-space:nowrap; text-align:center; }
    input, select, textarea, button { padding:0.4rem; margin-bottom:0.5rem; width:100%; border:1px solid #ccc; border-radius:0.25rem; font-size:0.85rem; }
    button.primary { background:var(--nav-bg); color:white; border:none; font-weight:bold; cursor:pointer; }
    button.primary:hover { background:#4338ca; }
    .history-item { margin-bottom:0.5rem; font-size:0.9rem; }
    .grid { display:grid; gap:1rem; }
    .grid.small { grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); font-size:0.8rem; }
    .grid.medium { grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); }
    .grid.large { grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
    .grid .card { margin-bottom:0; }
    .card img { width:100%; object-fit:cover; border-radius:0.25rem; }
    .grid .card img, .grid .cover-placeholder { aspect-ratio:2/3; height:auto; }
    .grid .card img { object-fit:contain; }
    .grid .update-btn { width:100%; }
    .grid.small .update-btn { font-size:0.75rem; }
    .grid.small .details p { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .view-size { display:flex; gap:0.25rem; }
    .view-size button { background:transparent; border:none; cursor:pointer; padding:0.2rem; border-radius:0.25rem; }
    .view-size button.active { background:var(--progress-bg); }
    .view-size .material-symbols-outlined { font-size:16px; color:var(--text-color); }
    .card.list { display:flex; align-items:center; gap:0.5rem; }
    .card.list img { width:50px; height:75px; margin-bottom:0; }
    .card.list .details { flex:1; }
    .card.list .cover-placeholder { width:50px; height:75px; margin-bottom:0; }
    .reading-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:0.5rem; }
    .reading-card { display:flex; flex-direction:column; align-items:center; text-align:center; cursor:pointer; position:relative; }
    .reading-card img {
      width:100%;
      aspect-ratio:2/3;
      height:auto;
      object-fit:contain;
      border-radius:0.25rem;
    }
    .cover-placeholder {
      width:100%;
      aspect-ratio:2/3;
      height:auto;
      background:rgba(0,0,0,0.2);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:0.25rem;
      padding:0.25rem;
      text-align:center;
    }
    .reading-card .progress-bar { width:100%; margin:0.25rem 0; }
    .reading-card .update-btn { width:100%; margin-top:0; }
    .meta-badge, .lido-badge {
      position:absolute;
      left:0;
      width:60%;
      height:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      z-index:2;
      pointer-events:none;
    }
    .meta-badge {
      top:0.5rem;
      background:#C4A200;
    }
    .lido-badge {
      top:0;
      background:#16A34A;
    }
    .percent-circle {
      position:absolute;
      top:0;
      left:0.25rem;
      width:24px;
      height:24px;
      border-radius:50%;
      background:#FACC15;
      color:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.7rem;
      font-weight:700;
      z-index:3;
    }
    .cover-wrapper { position:relative; display:inline-block; margin-bottom:0.5rem; }
    .card .cover-wrapper, .reading-card .cover-wrapper { width:100%; }
    .card.list .cover-wrapper { width:50px; height:75px; }
    .goal-slot.filled .cover-wrapper { width:100%; height:100%; }
    .cover-icon {
      position:absolute;
      bottom:0.25rem;
      right:0.25rem;
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:0.15rem;
      border-radius:0.25rem;
      font-size:0.75rem;
    }
    .history-layout { display:flex; gap:6rem; align-items:flex-start; }
    .history-layout .cover-wrapper { width:120px; height:180px; }
    .history-layout img { width:100%; height:100%; object-fit:cover; border-radius:0.25rem; }
    .history-info { display:flex; gap:1rem; align-items:flex-start; }
    .history-details { margin-top:0; }
    .history-synopsis { flex:1; }
    .history-reading { margin-top:1rem; }
    .view-toggle { display:flex; flex-direction:column; gap:0.3rem; align-items:flex-end; }
    .view-mode { display:flex; gap:0.3rem; }
    .view-toggle button { background:transparent; border:none; cursor:pointer; padding:0.2rem; font-size:1.2rem; border-radius:0.25rem; }
    .view-toggle button.active { background:var(--nav-bg); color:#fff; }
    #modal-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #modal { background:var(--card-bg); padding:0.5rem; border-radius:0.25rem; width:200px; box-shadow:0 2px 8px var(--card-shadow); }
    .goal-slots { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:1rem; }
    .goal-slot { width:60px; height:80px; background:rgba(0,0,0,0.2); color:#fff; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; cursor:pointer; font-size:1.5rem; }
    .goal-slot.filled { background:var(--card-bg); color:var(--text-color); font-size:0.7rem; padding:0.25rem; text-align:center; position:relative; }
    .goal-slot.filled img { width:100%; height:100%; object-fit:cover; border-radius:0.25rem; }
    #book-select-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #book-select { background:var(--card-bg); padding:1rem; border-radius:0.25rem; width:300px; max-height:80vh; overflow-y:auto; box-shadow:0 2px 8px var(--card-shadow); }
    #book-select input { margin-bottom:0.5rem; }
    .book-option { padding:0.3rem 0; cursor:pointer; }
    .book-option:hover { background:var(--progress-bg); }
    #slot-options-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #slot-options { background:var(--card-bg); padding:0.75rem; padding-bottom:1.8rem; border-radius:0.25rem; box-shadow:0 2px 8px var(--card-shadow); display:flex; flex-direction:column; align-items:flex-start; position:relative; }
    #slot-options button { background:transparent; border:none; cursor:pointer; color:var(--text-color); }
    #slot-view { font-size:1rem; margin-bottom:0.8rem; }
    #slot-remove { position:absolute; bottom:0.5rem; right:0.5rem; font-size:0.8rem; }
    #slot-options button:hover { opacity:0.7; }
    .goal-count { display:flex; align-items:center; gap:0.5rem; }
    .goal-count input { width:60px; margin:0; }
    .year-select { width:auto; margin-right:0.5rem; }
    .tabs { display:flex; gap:0.5rem; margin-bottom:1rem; border-bottom:2px solid var(--progress-bg); width:100%; max-width:400px; }
    .tab { flex:1; position:relative; padding:0.5rem 0; background:transparent; border:none; font-size:0.9rem; font-weight:500; color:var(--text-color); cursor:pointer; transition:color 0.3s; }
    .tab::after { content:''; position:absolute; left:0; bottom:-2px; width:0; height:2px; background:var(--nav-bg); transition:width 0.3s; }
    .tab:hover { color:var(--nav-bg); }
    .tab:hover::after { width:100%; }
    .tab.active { color:var(--nav-bg); }
    .tab.active::after { width:100%; }
    .dashboard-columns { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .dashboard-left, .dashboard-right { display:flex; flex-direction:column; gap:1rem; }
    .category-group { margin-bottom:1rem; }
    .category-group h3 { margin-bottom:0.5rem; border-left:4px solid var(--nav-bg); padding-left:0.5rem; }

    /* Calendar widget */
    .calendar-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
    .calendar-nav button { width:auto; margin:0; background:transparent; border:none; cursor:pointer; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:0.5rem; justify-items:center; }
    .calendar-day { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:var(--progress-bg); color:var(--text-color); }
    .calendar-day.read { background:#16A34A; color:#fff; }
    .calendar-day.empty { background:transparent; }
    .card .details p { display:flex; align-items:center; gap:0.25rem; }
    .type-icon { display:inline-flex; align-items:center; gap:0.25rem; }
    .type-icon i { font-size:1rem; }
  </style>
</head>
<body>
  <nav>
    <h2>📚 Biblioteca</h2>
    <button onclick="navegar('dashboard')">Dashboard</button>
    <button onclick="navegar('biblioteca')">Livros</button>
    <button onclick="navegar('adicionar')">Adicionar</button>
    <button onclick="navegar('relatorios')">Relatórios</button>
    <button onclick="navegar('config')">Config</button>
    <button onclick="navegar('meta_anual')">Meta Anual</button>
    <button onclick="alternarTema()">Tema</button>
  </nav>
  <main>
    <header>
      <h1 id="tituloPagina">Dashboard</h1>
      <span id="metaAnualPaginas"></span>
      <span>📅 <strong id="today"></strong></span>
    </header>
    <div id="conteudo"></div>
  </main>
  <div id="modal-overlay" onclick="hideModal()">
    <div id="modal" onclick="event.stopPropagation()">
      <input type="date" id="modal-date" />
      <select id="modal-type"><option value="pages">Páginas</option><option value="percent">%</option></select>
      <input type="number" id="modal-value" placeholder="Valor" />
      <div id="modal-progress" style="margin:0.5rem 0;"></div>
      <button id="modal-save" class="primary">OK</button>
      <button onclick="hideModal()" style="background:transparent;color:var(--text-color);padding:0.3rem;width:100%">X</button>
    </div>
  </div>
  <div id="book-select-overlay" onclick="closeBookSelector()">
    <div id="book-select" onclick="event.stopPropagation()">
      <input type="text" id="book-search" placeholder="Buscar" />
      <div id="book-list"></div>
    </div>
  </div>
  <div id="slot-options-overlay" onclick="closeSlotOptions()">
    <div id="slot-options" onclick="event.stopPropagation()">
      <button id="slot-view" title="Exibir">Exibir</button>
      <button id="slot-remove" title="Remover">🗑️</button>
    </div>
  </div>
  <script>
    const desafios = [
      { id:'bookmark_sprint', name:'Meta 15 pág/dia', pagesPerDay:15 },
      { id:'reading_marathon', name:'Meta 30 pág/dia', pagesPerDay:30 },
      { id:'weekend_warrior', name:'Meta 50 pág/dia', pagesPerDay:50 }
    ].map(d => ({ ...d, description: `Ler ${d.pagesPerDay} pág/dia` }));
    let livros = JSON.parse(localStorage.getItem('livros')) || [];
    livros = livros.map(b => {
      const history = b.history || [];
      const startDate = b.startDate || (history.length ? history[0].date : null);
      const endDate = b.endDate || (b.status === 'lido' && history.length ? history[history.length - 1].date : null);
      return { ...b, history, resumo: b.resumo || '', categoria: b.categoria || '', startDate, endDate };
    });
    let metaAnnual = JSON.parse(localStorage.getItem('metaAnnual')) || [];
    let metaAnnualCount = parseInt(localStorage.getItem('metaAnnualCount')) || metaAnnual.length;
    let selectingSlot = null;
    let viewMode = localStorage.getItem('viewMode') || 'list';
    let gridSize = localStorage.getItem('gridSize') || 'large';
    const monthNames = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    const conteudo = document.getElementById('conteudo');

    function getLocalDateISO(date = new Date()) {
      const tzOffset = date.getTimezoneOffset() * 60000;
      return new Date(date.getTime() - tzOffset).toISOString().split('T')[0];
    }

    document.getElementById('today').textContent = new Date().toLocaleDateString();
    let currentDate = getLocalDateISO();
    if (localStorage.getItem('tema')) document.documentElement.setAttribute('data-theme', localStorage.getItem('tema'));
    document.getElementById('book-search').addEventListener('input', e => renderBookList(e.target.value));
    setInterval(() => {
      const todayStr = getLocalDateISO();
      if (todayStr !== currentDate) {
        currentDate = todayStr;
        document.getElementById('today').textContent = new Date().toLocaleDateString();
        if (document.getElementById('tituloPagina').textContent === 'Dashboard') carregarDashboard();
      }
    }, 60 * 1000);
    let selectedYear = new Date().getFullYear();
    let selectedTab = 'lendo';
    let groupType = 'none';
    let selectedCategory = 'all';
    let currentPage = 'dashboard';

    function getTipoIcon(tipo) {
      const iconMap = {
        'Físico': 'fa-solid fa-book',
        'E-book': 'fa-solid fa-tablet-screen-button',
        'Audiobook': 'fa-solid fa-headphones'
      };
      return iconMap[tipo] || '';
    }
    function renderTipo(tipo) {
      const icon = getTipoIcon(tipo);
      if (!icon) return tipo || '';
      return `<span class="type-icon"><i class="${icon}"></i><span>${tipo}</span></span>`;
    }
    function renderTipoIcon(tipo) {
      const icon = getTipoIcon(tipo);
      return icon ? `<span class="cover-icon"><i class="${icon}"></i></span>` : '';
    }

    function salvarLivros() { localStorage.setItem('livros', JSON.stringify(livros)); }
    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year.slice(2)}`;
    }
    function migrateBooksForNewYear() {
      const cy = new Date().getFullYear();
      livros.forEach(b => {
        b.status = b.status || (b.lidas >= b.paginas ? 'lido' : (b.lidas > 0 ? 'lendo' : 'quero_ler'));
        if (b.status === 'lido') {
          b.completedYear = b.completedYear || cy;
        } else {
          if (!b.year || b.year < cy) b.year = cy;
        }
      });
      salvarLivros();
    }
    migrateBooksForNewYear();
    function salvarMeta() {
      localStorage.setItem('metaAnnual', JSON.stringify(metaAnnual));
      localStorage.setItem('metaAnnualCount', metaAnnualCount);
    }
    function alternarTema() { const t = document.documentElement.getAttribute('data-theme'); const n = t === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('tema', n); }
    function setViewMode(m) {
      viewMode = m;
      localStorage.setItem('viewMode', m);
      renderSizeIcons();
      renderBooks();
      const toggle = document.querySelector('.view-toggle');
      if (toggle) {
        toggle.querySelectorAll('button[data-mode]').forEach(btn => btn.classList.remove('active'));
        const btn = toggle.querySelector(`button[data-mode="${m}"]`);
        if (btn) btn.classList.add('active');
      }
    }

    function setGridSize(s) {
      gridSize = s;
      localStorage.setItem('gridSize', s);
      renderSizeIcons();
      renderBooks();
    }

    function renderSizeIcons() {
      const div = document.getElementById('sizeOptions');
      if (!div) return;
      if (viewMode !== 'grid') { div.innerHTML = ''; return; }
      div.className = 'view-size';
      div.innerHTML = `
        <button class="${gridSize==='small'?'active':''}" onclick="setGridSize('small')" title="Pequeno">
          <span class="material-symbols-outlined">grid_view</span>
        </button>
        <button class="${gridSize==='medium'?'active':''}" onclick="setGridSize('medium')" title="Médio">
          <span class="material-symbols-outlined">view_module</span>
        </button>
        <button class="${gridSize==='large'?'active':''}" onclick="setGridSize('large')" title="Grande">
          <span class="material-symbols-outlined">view_comfy</span>
        </button>
      `;
    }

    function navegar(p) {
      currentPage = p;
      document.getElementById('tituloPagina').textContent = p.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('metaAnualPaginas').textContent = '';
      conteudo.innerHTML = '';
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('onclick') === `navegar('${p}')`);
      });
      switch (p) {
        case 'dashboard': carregarDashboard(); break;
        case 'biblioteca': carregarBiblioteca(); break;
        case 'adicionar': carregarFormulario(); break;
        case 'relatorios': carregarRelatorios(); break;
        case 'config': carregarConfiguracoes(); break;
        case 'meta_anual': carregarMetaAnual(); break;
      }
    }

    let currentEditId = null;
    let modalBack = 'biblioteca';
    function showModal(id) {
      modalBack = currentPage;
      currentEditId = id;
      const book = livros.find(b => b.id === id);
      document.getElementById('modal-date').value = getLocalDateISO();
      const typeSelect = document.getElementById('modal-type');
      if (book.tipo === 'Audiobook') {
        typeSelect.value = 'percent';
        typeSelect.style.display = 'none';
      } else {
        typeSelect.value = 'pages';
        typeSelect.style.display = '';
      }
      const valueInput = document.getElementById('modal-value');
      valueInput.value = '';
      const pct = book.tipo === 'Audiobook' ? book.lidas : Math.round((book.lidas / book.paginas) * 100);
      const progressText = book.tipo === 'Audiobook'
        ? `${book.lidas}%`
        : `${book.lidas}/${book.paginas} (${pct}%)`;
      document.getElementById('modal-progress').textContent = progressText;
      document.getElementById('modal-overlay').style.display = 'flex';
      valueInput.focus();
      valueInput.select();
    }
    function hideModal() {
      document.getElementById('modal-overlay').style.display = 'none';
      currentEditId = null;
      document.getElementById('modal-progress').textContent = '';
      document.getElementById('modal-type').style.display = '';
    }

    function saveModal() {
      const date = document.getElementById('modal-date').value;
      const type = document.getElementById('modal-type').value;
      const val = parseFloat(document.getElementById('modal-value').value);
      const book = livros.find(b => b.id === currentEditId);
      if (!date || isNaN(val)) return alert('Inválido');
      const old = book.lidas;
      let np, pct;
      if (book.tipo === 'Audiobook') {
        np = Math.min(val, 100);
        pct = np;
      } else {
        const npPages = type === 'percent' ? Math.round(book.paginas * (val / 100)) : val;
        np = Math.min(npPages, book.paginas);
        pct = Math.round((np / book.paginas) * 100);
      }
      const delta = np - old;
      book.lidas = np;
      if (book.lidas > 0 && !book.startDate) {
        book.startDate = date;
      } else if (book.lidas === 0) {
        book.startDate = null;
      }
      book.history.push({ date, pages: book.lidas, percent: pct, delta, timestamp: Date.now() });
      const finished = book.tipo === 'Audiobook' ? book.lidas >= 100 : book.lidas >= book.paginas;
      if (finished) {
        book.status = 'lido';
        book.completedYear = new Date().getFullYear();
        book.lidas = book.tipo === 'Audiobook' ? 100 : book.paginas;
        book.endDate = book.endDate || date;
      } else if (book.lidas > 0) {
        book.status = 'lendo';
        book.year = new Date().getFullYear();
        book.endDate = null;
      } else {
        book.status = 'quero_ler';
        book.year = new Date().getFullYear();
        book.endDate = null;
      }
      salvarLivros(); hideModal(); navegar(modalBack);
    }

    document.getElementById('modal-save').addEventListener('click', saveModal);
    document.getElementById('modal-value').addEventListener('keydown', e => { if (e.key === 'Enter') saveModal(); });

    function carregarDashboard() {
      const hoje = new Date();
      const hojeStr = getLocalDateISO(hoje);
      const weekAgo = new Date(hoje); weekAgo.setDate(hoje.getDate() - 6);
      const weekAgoStr = getLocalDateISO(weekAgo);
      let daily = 0, weekly = 0;
      livros.forEach(b => b.history.forEach(h => {
        const pages = h.delta || 0;
        if (h.date === hojeStr) daily += pages;
        if (h.date >= weekAgoStr && h.date <= hojeStr) weekly += pages;
      }));
      const selected = livros.filter(b => metaAnnual.includes(b.id));
      const remaining = selected.reduce((sum, b) => sum + Math.max(0, b.paginas - b.lidas), 0);
      const endYear = new Date(hoje.getFullYear(), 11, 31);
      const msPerDay = 1000 * 60 * 60 * 24;
      const daysLeft = Math.ceil((endYear - hoje) / msPerDay) + 1;
      const perDay = daysLeft > 0 ? Math.ceil(remaining / daysLeft) : remaining;
      const trophy = daily >= perDay ? ' 🏆' : '';
      document.getElementById('metaAnualPaginas').textContent = `${daily} pág lidas · ${perDay} pág/dia${trophy}`;
      const desafioId = localStorage.getItem('desafio');
      const d = desafios.find(x => x.id === desafioId) || desafios[0];
      const dm = d.pagesPerDay;
      const wm = dm * 7;
      const at = metaAnnualCount;
      const ac = selected.filter(b => b.lidas >= b.paginas).length;
      const dp = Math.min(100, Math.round(daily / dm * 100));
      const wp = Math.min(100, Math.round(weekly / wm * 100));
      const ap = at > 0 ? Math.min(100, Math.round(ac / at * 100)) : 0;
      const progressCard = `
        <div class=\"card\">
          <h2>Progresso Geral</h2>
          <p>Diário: ${daily}/${dm} pág (${dp}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${dp}%\"></div></div>
          <p>Semanal: ${weekly}/${wm} pág (${wp}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${wp}%\"></div></div>
          <p>Anual: ${ac}/${at} livros (${ap}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${ap}%\"></div></div>
        </div>`;
      const rem = Math.max(0, d.pagesPerDay - daily);
      const pct = dp;
      const challengeTrophy = pct >= 100 ? '🏆 Desafio Concluído! 🏆' : '';
      const metaCard = `
        <div class=\"card\">
          ${challengeTrophy && `<div style=\"font-size:2rem;text-align:center\">${challengeTrophy}</div>`}
          <h2>Meta diária</h2>
          <p>${d.description}</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${pct}%\"></div></div>
          <p>${daily}/${dm} pág (${pct}%)</p>
        </div>`;
      const summaryCard = `
        <div class=\"card\">
          <h2>Resumo</h2>
          <p>Total: ${daily} pág</p>
          <p>Meta diária: ${d.pagesPerDay} pág</p>
          <p>Restante: ${rem} pág</p>
        </div>`;
      const calendarCard = `
        <div class=\"card\">
          <h2>Leitura Mensal</h2>
          <div class=\"calendar-nav\">
            <button onclick=\"alterarMes(-1)\">&lt;</button>
            <span id=\"calendar-month\">${monthNames[calendarMonth]} ${calendarYear}</span>
            <button onclick=\"alterarMes(1)\">&gt;</button>
          </div>
          <div id=\"calendar-container\">${gerarCalendarioMensal()}</div>
        </div>`;
      const getLastUpdate = b => {
        if (b.history && b.history.length) {
          const last = b.history[b.history.length - 1];
          return last.timestamp || new Date(last.date).getTime();
        }
        return b.startDate ? new Date(b.startDate).getTime() : 0;
      };
      const reading = livros
        .filter(b => b.lidas > 0 && b.lidas < b.paginas)
        .sort((a, b) => getLastUpdate(b) - getLastUpdate(a));
      let readingCard = '';
      if (reading.length) {
        const items = reading.map(b => {
          const isAudio = b.tipo === 'Audiobook';
          const pc = isAudio ? b.lidas : Math.round((b.lidas / b.paginas) * 100);
          const progressText = isAudio ? `${pc}%` : `${b.lidas}/${b.paginas} (${pc}%)`;
          const coverImg = b.capa
            ? `<img src=\"${b.capa}\" alt=\"Capa de ${b.titulo}\">`
            : `<div class=\"cover-placeholder\">${b.titulo}</div>`;
          const cover = `<div class=\"cover-wrapper\">${coverImg}${renderTipoIcon(b.tipo)}</div>`;
          const badge = metaAnnual.includes(b.id) ? '<div class="meta-badge">META</div>' : '';
          return `
            <div class=\"reading-card\" onclick=\"mostrarHistorico(${b.id},'dashboard')\">
              ${badge}
              ${cover}
              <div>${progressText}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
              <button class="update-btn" onclick="event.stopPropagation();showModal(${b.id});">Atualizar</button>
            </div>
          `;
        }).join('');
        readingCard = `
          <div class=\"card\">
            <h2>Em leitura</h2>
            <div class=\"reading-grid\">
              ${items}
            </div>
          </div>`;
      }
      const html = `
        <div class=\"dashboard-columns\">
          <div class=\"dashboard-left\">
            ${metaCard}
            ${progressCard}
            ${summaryCard}
            ${calendarCard}
          </div>
          <div class=\"dashboard-right\">
            ${readingCard}
          </div>
        </div>`;
      conteudo.innerHTML = html;
    }

    function gerarCalendarioMensal(year = calendarYear, month = calendarMonth) {
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const pagesByDate = {};
      livros.forEach(b => {
        (b.history || []).forEach(h => {
          const d = new Date(h.date);
          if (d.getFullYear() === year && d.getMonth() === month) {
            const key = h.date;
            const p = h.delta || h.pages || 0;
            pagesByDate[key] = (pagesByDate[key] || 0) + p;
          }
        });
      });
      let html = '<div class="calendar">';
      for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day empty"></div>';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const pages = pagesByDate[dateStr] || 0;
        if (pages > 0) {
          html += `<div class="calendar-day read">${pages}</div>`;
        } else {
          html += `<div class="calendar-day">${day}</div>`;
        }
      }
      html += '</div>';
      return html;
    }

    function alterarMes(delta) {
      calendarMonth += delta;
      if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
      if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
      document.getElementById('calendar-month').textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
      document.getElementById('calendar-container').innerHTML = gerarCalendarioMensal();
    }

    function carregarMetaAnual() {
      let html = `<div class="card">
        <h2>Meta Anual</h2>
        <div class="goal-count">
          <label for="goalCount">Quantidade de livros:</label>
          <input type="number" id="goalCount" min="0" value="${metaAnnualCount}" />
        </div>
        <div id="goalSlots" class="goal-slots"></div>
      </div>`;
      conteudo.innerHTML = html;
      document.getElementById('goalCount').addEventListener('change', e => {
        metaAnnualCount = parseInt(e.target.value) || 0;
        if (metaAnnual.length > metaAnnualCount) metaAnnual = metaAnnual.slice(0, metaAnnualCount);
        salvarMeta();
        renderGoalSlots();
      });
      renderGoalSlots();
    }

    function renderGoalSlots() {
      const container = document.getElementById('goalSlots');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < metaAnnualCount; i++) {
        const slot = document.createElement('div');
        const id = metaAnnual[i];
        if (id) {
          const book = livros.find(b => b.id === id);
          slot.className = 'goal-slot filled';
          const pc = book ? (book.tipo === 'Audiobook' ? book.lidas : Math.round((book.lidas / book.paginas) * 100)) : 0;
          const isCompleted = book && book.lidas >= book.paginas;
          const pctCircle = !isCompleted ? `<div class="percent-circle">${pc}%</div>` : '';
          const badge = isCompleted ? '<div class="lido-badge">Lido</div>' : '';
          if (book && book.capa) {
            slot.innerHTML = `${pctCircle}${badge}<div class="cover-wrapper"><img src="${book.capa}" alt="${book.titulo}">${renderTipoIcon(book.tipo)}</div>`;
            slot.style.padding = '0';
          } else {
            slot.innerHTML = `${pctCircle}${badge}${book ? book.titulo : ''}`;
            slot.style.padding = '';
          }
          slot.onclick = () => openSlotOptions(i);
        } else {
          slot.className = 'goal-slot';
          slot.textContent = '+';
          slot.style.padding = '';
          slot.onclick = () => openBookSelector(i);
        }
        container.appendChild(slot);
      }
    }

    function openBookSelector(i) {
      selectingSlot = i;
      document.getElementById('book-select-overlay').style.display = 'flex';
      document.getElementById('book-search').value = '';
      renderBookList('');
    }

    function closeBookSelector() {
      document.getElementById('book-select-overlay').style.display = 'none';
      selectingSlot = null;
    }

    function renderBookList(term) {
      const list = livros
        .filter(b => b.titulo.toLowerCase().includes(term.toLowerCase()))
        .filter(b => !metaAnnual.includes(b.id));
      document.getElementById('book-list').innerHTML = list.map(b => `<div class="book-option" onclick="chooseBook(${b.id})">${b.titulo}</div>`).join('');
    }

    function chooseBook(id) {
      if (selectingSlot === null) return;
      if (metaAnnual.includes(id) && metaAnnual[selectingSlot] !== id) {
        alert('Livro já selecionado');
        return;
      }
      metaAnnual[selectingSlot] = id;
      salvarMeta();
      renderGoalSlots();
      closeBookSelector();
    }

    function openSlotOptions(i) {
      selectingSlot = i;
      document.getElementById('slot-options-overlay').style.display = 'flex';
    }

    function closeSlotOptions() {
      document.getElementById('slot-options-overlay').style.display = 'none';
      selectingSlot = null;
    }

    document.getElementById('slot-view').addEventListener('click', () => {
      if (selectingSlot === null) return;
      const id = metaAnnual[selectingSlot];
      closeSlotOptions();
      if (id) mostrarHistorico(id, 'meta_anual');
    });

    document.getElementById('slot-remove').addEventListener('click', () => {
      if (selectingSlot === null) return;
      metaAnnual[selectingSlot] = null;
      salvarMeta();
      renderGoalSlots();
      closeSlotOptions();
    });

    function carregarBiblioteca() {
      conteudo.innerHTML = '';
      const top = document.createElement('div');
      top.style = 'margin-bottom:1rem; display:flex; justify-content:space-between; align-items:center;';
      top.innerHTML = `
        <select id="yearSelect" class="year-select" onchange="changeYear(this.value)"></select>
        <div class="view-toggle">
          <div class="view-mode">
            <button data-mode="list" class="${viewMode==='list'?'active':''}" onclick="setViewMode('list')" title="Lista"><span class="material-symbols-outlined">view_list</span></button>
            <button data-mode="grid" class="${viewMode==='grid'?'active':''}" onclick="setViewMode('grid')" title="Grade"><span class="material-symbols-outlined">grid_view</span></button>
          </div>
          <div id="sizeOptions"></div>
        </div>`;
      conteudo.appendChild(top);
      renderSizeIcons();
      const tabsDiv = document.createElement('div');
      tabsDiv.id = 'tabsContainer';
      conteudo.appendChild(tabsDiv);
      const groupDiv = document.createElement('div');
      groupDiv.id = 'groupContainer';
      conteudo.appendChild(groupDiv);
      const booksDiv = document.createElement('div');
      booksDiv.id = 'booksContainer';
      conteudo.appendChild(booksDiv);
      populateYearSelect();
      renderTabs();
      renderGroupToggle();
      renderBooks();
    }

    function populateYearSelect() {
      const sel = document.getElementById('yearSelect');
      const cy = new Date().getFullYear();
      let opts = '<option value="all">Todos</option>';
      for (let y = cy; y >= 2020; y--) {
        opts += `<option value="${y}" ${selectedYear===y?'selected':''}>${y}</option>`;
      }
      sel.innerHTML = opts;
    }

    function changeYear(val) {
      selectedYear = val === 'all' ? 'all' : parseInt(val);
      if (selectedYear === new Date().getFullYear()) selectedTab = 'lendo';
      selectedCategory = 'all';
      renderTabs();
      renderGroupToggle();
      renderBooks();
    }

    function renderTabs() {
      const cy = new Date().getFullYear();
      const tabsDiv = document.getElementById('tabsContainer');
      if (selectedYear !== cy) { tabsDiv.innerHTML = ''; return; }
      tabsDiv.className = 'tabs';
      tabsDiv.innerHTML = `
        <button class="tab ${selectedTab==='lendo'?'active':''}" onclick="setTab('lendo')">Lendo</button>
        <button class="tab ${selectedTab==='quero'?'active':''}" onclick="setTab('quero')">Quero ler</button>
        <button class="tab ${selectedTab==='lido'?'active':''}" onclick="setTab('lido')">Lido</button>
      `;
    }

    function renderGroupToggle() {
      const div = document.getElementById('groupContainer');
      if (!div) return;
      const cy = new Date().getFullYear();
      if (selectedYear === cy && (selectedTab === 'lendo' || selectedTab === 'quero')) {
        div.style = 'display:flex; gap:0.5rem; align-items:center;';
        const groupOpts = [
          `<option value="none" ${groupType==='none'?'selected':''}>---</option>`,
          `<option value="genero" ${groupType==='genero'?'selected':''}>Gênero</option>`
        ].join('');
        let html = `Agrupar <select style="width:auto" onchange="setGroupType(this.value)">${groupOpts}</select>`;
        if (groupType === 'genero') {
          const status = selectedTab === 'lendo' ? 'lendo' : 'quero_ler';
          const categories = Array.from(new Set(livros
            .filter(b => b.status === status && b.year === cy)
            .map(b => b.categoria || 'Sem categoria'))).sort();
          const opts = ['<option value="all">Todos</option>', ...categories.map(c => `<option value="${c}" ${selectedCategory===c?'selected':''}>${c}</option>`)].join('');
          html += ` <span>Filtrar</span> <select style="width:auto" onchange="setCategoryFilter(this.value)">${opts}</select>`;
        }
        div.innerHTML = html;
      } else {
        div.innerHTML = '';
        div.style = '';
      }
    }

    function setGroupType(val) {
      groupType = val;
      selectedCategory = 'all';
      renderGroupToggle();
      renderBooks();
    }

    function setCategoryFilter(val) { selectedCategory = val; renderBooks(); }

    function setTab(t) {
      selectedTab = t;
      selectedCategory = 'all';
      renderTabs();
      renderGroupToggle();
      renderBooks();
    }

    function appendBookCard(parent, b) {
      const isAudio = b.tipo === 'Audiobook';
      const pc = isAudio ? b.lidas : Math.round((b.lidas/b.paginas)*100);
      const div = document.createElement('div');
      div.className = 'card';
      if (viewMode === 'list') div.classList.add('list');
      div.onclick = () => mostrarHistorico(b.id);
      const coverImg = b.capa
        ? `<img src="${b.capa}" alt="Capa de ${b.titulo}">`
        : `<div class="cover-placeholder">${b.titulo}</div>`;
      const cover = `<div class="cover-wrapper">${coverImg}${renderTipoIcon(b.tipo)}</div>`;
      const start = b.startDate ? `<p>Início: ${formatDate(b.startDate)}</p>` : '';
      const end = b.endDate ? `<p>Fim: ${formatDate(b.endDate)}</p>` : '';
      const tipoInfo = b.tipo ? `<p>Tipo: ${renderTipo(b.tipo)}</p>` : '';
      const updateTxt = (viewMode === 'grid' && gridSize === 'small') ? 'Atualizar' : 'Atualizar progresso';
      const progressText = isAudio ? `${pc}%` : `${b.lidas}/${b.paginas} (${pc}%)`;
      div.innerHTML = `
            ${cover}
            <div class="details">
              <p>${progressText}</p>
              <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
              ${tipoInfo}
              ${start}
              ${end}
              <button class="update-btn" onclick="event.stopPropagation();showModal(${b.id});">${updateTxt}</button>
            </div>
          `;
      parent.appendChild(div);
    }

    function renderBooks() {
      const container = document.getElementById('booksContainer');
      if (!container) return;
      container.innerHTML = '';
      let list = [];
      const cy = new Date().getFullYear();
      if (selectedYear === 'all') {
        list = livros.filter(b => b.status === 'lido');
      } else if (selectedYear === cy) {
        if (selectedTab === 'lendo') list = livros.filter(b => b.status==='lendo' && b.year===cy);
        else if (selectedTab === 'quero') list = livros.filter(b => b.status==='quero_ler' && b.year===cy);
        else list = livros.filter(b => b.status==='lido' && b.completedYear===cy);
      } else {
        list = livros.filter(b => b.status==='lido' && b.completedYear===selectedYear);
      }
      if (groupType === 'genero' && selectedCategory !== 'all') {
        list = list.filter(b => (b.categoria || 'Sem categoria') === selectedCategory);
      }
      if (!list.length) { container.innerHTML = '<p>Nenhum livro.</p>'; return; }
      if (groupType === 'genero' && (selectedTab === 'lendo' || selectedTab === 'quero')) {
        container.className = '';
        const groups = {};
        list.forEach(b => {
          const cat = b.categoria || 'Sem categoria';
          (groups[cat] = groups[cat] || []).push(b);
        });
        Object.keys(groups).sort().forEach(cat => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'category-group';
          const h = document.createElement('h3');
          h.textContent = cat;
          groupDiv.appendChild(h);
          const booksDiv = document.createElement('div');
          if (viewMode === 'grid') booksDiv.className = 'grid ' + gridSize;
          groupDiv.appendChild(booksDiv);
          groups[cat].forEach(b => appendBookCard(booksDiv, b));
          container.appendChild(groupDiv);
        });
      } else {
        if (viewMode === 'grid') container.className = 'grid ' + gridSize; else container.className = '';
        list.forEach(b => appendBookCard(container, b));
      }
    }

    function mostrarHistorico(id, back='biblioteca') {
      const book = livros.find(b => b.id === id);
      document.getElementById('tituloPagina').textContent = 'Histórico';
      const cover = book.capa
        ? `<div class="cover-wrapper"><img src="${book.capa}" alt="Capa de ${book.titulo}">${renderTipoIcon(book.tipo)}</div>`
        : '';
      let html = `
        <div class="card">
          <button onclick="navegar('${back}')" style="background:transparent;color:var(--text-color);border:none;margin-bottom:1rem;display:block;width:auto;padding:0;text-align:left">◀ Voltar</button>
          <div class="history-layout">
            <div class="history-info">
              ${cover}
              <div class="history-details">
                <h2>${book.titulo}</h2>
                ${book.autor ? `<p><strong>Autor:</strong> ${book.autor}</p>` : ''}
                ${book.editora ? `<p><strong>Editora:</strong> ${book.editora}</p>` : ''}
                ${book.categoria ? `<p><strong>Categoria:</strong> ${book.categoria}</p>` : ''}
                ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                ${book.tipo ? `<p><strong>Tipo:</strong> ${renderTipo(book.tipo)}</p>` : ''}
                ${book.startDate ? `<p><strong>Início:</strong> ${formatDate(book.startDate)}</p>` : ''}
                ${book.endDate ? `<p><strong>Fim:</strong> ${formatDate(book.endDate)}</p>` : ''}
              </div>
            </div>
            <div class="history-synopsis">
              <h3>Sinopse</h3>
              <p>${book.resumo || 'Sem sinopse.'}</p>
            </div>
          </div>
          <div class="history-reading">
            <h3>Histórico de leitura</h3>`;
      const sorted = book.history.slice().sort((a,b) => b.timestamp - a.timestamp);
      if (!sorted.length) html += '<p>Nenhum progresso registrado.</p>';
      else sorted.forEach(h => {
        const unit = book.tipo === 'Audiobook' ? '%' : 'pág';
        html += `<div class="history-item">${h.date}: ${h.pages} ${unit} (${h.percent}%)</div>`;
      });
      html += `
            <button class="update-btn" onclick="showModal(${id});event.stopPropagation();">Atualizar progresso</button>
            <button class="update-btn" onclick="event.stopPropagation();editarLivro(${id}, '${back}');">Editar</button>
          </div>
        </div>`;
      conteudo.innerHTML = html;
    }

    function carregarFormulario() {
      conteudo.innerHTML = `
        <div class="card">
          <h2>Adicionar Livro</h2>
          <input id="isbn" placeholder="ISBN" />
          <button class="update-btn" onclick="buscarISBN()">Buscar</button>
          <input id="titulo" placeholder="Título" />
          <input id="autor" placeholder="Autor" />
          <input id="editora" placeholder="Editora" />
          <input id="categoria" placeholder="Categoria" />
          <textarea id="resumo" placeholder="Resumo"></textarea>
          <input id="capa" placeholder="URL da capa" />
          <input id="paginas" type="number" placeholder="Páginas" />
          <input id="lidas" type="number" placeholder="Lidas" />
          <input id="percent" type="number" placeholder="Porcentagem" style="display:none" />
          <select id="tipo">
            <option value="" disabled selected>Tipo</option>
            <option value="Físico">Físico</option>
            <option value="E-book">E-book</option>
            <option value="Audiobook">Audiobook</option>
          </select>
          <button class="primary" onclick="adicionarLivro()">Salvar</button>
        </div>`;
      document.getElementById('tipo').addEventListener('change', e => {
        const isAudio = e.target.value === 'Audiobook';
        document.getElementById('paginas').style.display = isAudio ? 'none' : '';
        document.getElementById('lidas').style.display = isAudio ? 'none' : '';
        document.getElementById('percent').style.display = isAudio ? '' : 'none';
      });
    }

    async function buscarISBN() {
      const isbn = document.getElementById('isbn').value.trim();
      if (!isbn) { alert('Informe o ISBN'); return; }
      try {
        const resp = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
        const data = await resp.json();
        if (!data.items || data.totalItems === 0) { alert('Livro não encontrado'); return; }
        const info = data.items[0].volumeInfo;
        document.getElementById('titulo').value = info.title || '';
        document.getElementById('autor').value = info.authors ? info.authors.join(', ') : '';
        document.getElementById('editora').value = info.publisher || '';
        document.getElementById('categoria').value = (info.categories && info.categories[0]) || '';
        document.getElementById('resumo').value = info.description || '';
        document.getElementById('capa').value = (info.imageLinks && (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail)) || '';
        document.getElementById('paginas').value = info.pageCount || '';
      } catch (e) {
        alert('Erro ao buscar ISBN');
      }
    }

    function carregarRelatorios() {
      conteudo.innerHTML = `<div class="card"><h2>Relatórios</h2><p>Em breve</p></div>`;
    }

      function carregarConfiguracoes() {
        const saved = localStorage.getItem('desafio');
        const idSel = desafios.some(d => d.id === saved) ? saved : desafios[0].id;
        const opts = desafios.map(d => `<option value="${d.id}"${d.id===idSel?' selected':''}>${d.name}</option>`).join('');
        conteudo.innerHTML = `<div class="card">
          <h2>Configurações</h2>
          <select onchange="localStorage.setItem('desafio',this.value); navegar('dashboard')">
            ${opts}
          </select>
        <button class="primary" onclick="reiniciarBaseDados()">Reiniciar base de Dados</button>
      </div>`;
    }

    function reiniciarBaseDados() {
      if (confirm('Deseja realmente apagar todos os dados?')) {
        localStorage.clear();
        livros = [];
        metaAnnual = [];
        metaAnnualCount = 0;
        viewMode = 'list';
        document.documentElement.setAttribute('data-theme', 'light');
        navegar('dashboard');
      }
    }

    function adicionarLivro() {
      const isbn = document.getElementById('isbn').value;
      const t = document.getElementById('titulo').value;
      const a = document.getElementById('autor').value;
      const e = document.getElementById('editora').value;
      const cat = document.getElementById('categoria').value;
      const r = document.getElementById('resumo').value;
      const c = document.getElementById('capa').value;
      let pg = parseInt(document.getElementById('paginas').value);
      let ld = parseInt(document.getElementById('lidas').value) || 0;
      const tp = document.getElementById('tipo').value;
      if (tp === 'Audiobook') {
        pg = 100;
        ld = parseInt(document.getElementById('percent').value) || 0;
      }
      if (!t || isNaN(pg) || !tp) return alert('Preencha todos os campos!');
      const cy = new Date().getFullYear();
      let status = 'quero_ler', year = cy, completedYear = null;
      if (ld >= pg) { status = 'lido'; completedYear = cy; }
      else if (ld > 0) { status = 'lendo'; }
      const book = { id: Date.now(), titulo: t, autor: a, editora: e, categoria: cat, resumo: r, isbn, paginas: pg, lidas: ld, capa: c, tipo: tp, history: [], status, year, completedYear, startDate: null, endDate: null };
      if (ld > 0) {
        const date = getLocalDateISO();
        const pct  = Math.round((ld/pg)*100);
        book.history.push({ date, pages: ld, percent: pct, delta: ld, timestamp: Date.now() });
        book.startDate = date;
        if (ld >= pg) book.endDate = date;
      }
      livros.push(book);
      salvarLivros();
      navegar('biblioteca');
    }

    function editarLivro(id, back = 'biblioteca') {
      const book = livros.find(b => b.id === id);
      if (!book) return;
      conteudo.innerHTML = `
        <div class="card">
          <h2>Editar Livro</h2>
          <input id="isbn" placeholder="ISBN" value="${book.isbn || ''}" />
          <button class="update-btn" onclick="buscarISBN()">Buscar</button>
          <input id="titulo" placeholder="Título" value="${book.titulo || ''}" />
          <input id="autor" placeholder="Autor" value="${book.autor || ''}" />
          <input id="editora" placeholder="Editora" value="${book.editora || ''}" />
          <input id="categoria" placeholder="Categoria" value="${book.categoria || ''}" />
          <textarea id="resumo" placeholder="Resumo">${book.resumo || ''}</textarea>
          <input id="capa" placeholder="URL da capa" value="${book.capa || ''}" />
          <input id="paginas" type="number" placeholder="Páginas" />
          <input id="lidas" type="number" placeholder="Lidas" />
          <input id="percent" type="number" placeholder="Porcentagem" style="display:none" />
          <select id="tipo">
            <option value="" disabled>Tipo</option>
            <option value="Físico">Físico</option>
            <option value="E-book">E-book</option>
            <option value="Audiobook">Audiobook</option>
          </select>
          <button class="primary" onclick="salvarEdicao(${id}, '${back}')">Salvar</button>
        </div>`;
      const tipoEl = document.getElementById('tipo');
      const toggleFields = value => {
        const isAudio = value === 'Audiobook';
        document.getElementById('paginas').style.display = isAudio ? 'none' : '';
        document.getElementById('lidas').style.display = isAudio ? 'none' : '';
        document.getElementById('percent').style.display = isAudio ? '' : 'none';
        if (isAudio) {
          document.getElementById('percent').value = book.lidas || 0;
        } else {
          document.getElementById('paginas').value = book.paginas || '';
          document.getElementById('lidas').value = book.lidas || 0;
        }
      };
      tipoEl.addEventListener('change', e => toggleFields(e.target.value));
      tipoEl.value = book.tipo || '';
      toggleFields(tipoEl.value);
    }

    function salvarEdicao(id, back = 'biblioteca') {
      const isbn = document.getElementById('isbn').value;
      const t = document.getElementById('titulo').value;
      const a = document.getElementById('autor').value;
      const e = document.getElementById('editora').value;
      const cat = document.getElementById('categoria').value;
      const r = document.getElementById('resumo').value;
      const c = document.getElementById('capa').value;
      let pg = parseInt(document.getElementById('paginas').value);
      let ld = parseInt(document.getElementById('lidas').value) || 0;
      const tp = document.getElementById('tipo').value;
      if (tp === 'Audiobook') {
        pg = 100;
        ld = parseInt(document.getElementById('percent').value) || 0;
      }
      if (!t || isNaN(pg) || !tp) return alert('Preencha todos os campos!');
      const book = livros.find(b => b.id === id);
      book.isbn = isbn;
      book.titulo = t;
      book.autor = a;
      book.editora = e;
      book.categoria = cat;
      book.resumo = r;
      book.capa = c;
      book.paginas = pg;
      book.lidas = ld;
      book.tipo = tp;
      if (ld >= pg) { book.status = 'lido'; book.completedYear = new Date().getFullYear(); }
      else if (ld > 0) { book.status = 'lendo'; book.completedYear = null; }
      else { book.status = 'quero_ler'; book.completedYear = null; }
      salvarLivros();
      navegar(back);
    }

    navegar('dashboard');
  </script>
</body>
</html>
