<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Biblioteca Pessoal</title>
  <style>
    :root { --bg-color:#f0fdf4; --text-color:#333; --nav-bg:#22c55e; --card-bg:white; --card-shadow:rgba(0,0,0,0.06); --progress-bg:#e5e7eb; --progress-fill:#22c55e; }
    [data-theme="dark"] { --bg-color:#111827; --text-color:#e5e7eb; --nav-bg:#1f2937; --card-bg:#1e293b; --card-shadow:rgba(0,0,0,0.4); --progress-bg:#374151; --progress-fill:#10b981; }
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI',sans-serif; }
    body { display:grid; grid-template-columns:240px 1fr; height:100vh; background:var(--bg-color); color:var(--text-color); }
    nav { background:var(--nav-bg); padding:1rem; color:white; }
    nav h2 { font-size:1.2rem; margin-bottom:1rem; }
    nav button { width:100%; background:transparent; border:none; color:inherit; padding:0.5rem; text-align:left; cursor:pointer; border-radius:0.25rem; }
    nav button:hover { background:rgba(255,255,255,0.2); }
    main { padding:1rem; overflow-y:auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); padding:0.5rem 1rem; border-radius:0.5rem; box-shadow:0 2px 8px var(--card-shadow); margin-bottom:1rem; }
    header h1 { font-size:1.2rem; }
    .card { background:var(--card-bg); padding:1rem; border-radius:0.5rem; box-shadow:0 4px 12px var(--card-shadow); margin-bottom:1rem; cursor:default; }
    .progress-bar { background:var(--progress-bg); height:8px; border-radius:4px; overflow:hidden; margin:0.25rem 0; }
    .progress-fill { height:100%; background:var(--progress-fill); width:0%; }
    .update-btn { background:#e0e0e0; color:var(--text-color); border:none; border-radius:0.25rem; padding:0.4rem 0.6rem; font-size:0.85rem; cursor:pointer; margin-top:0.5rem; width:150px; white-space:nowrap; text-align:center; }
    input, select, button { padding:0.4rem; margin-bottom:0.5rem; width:100%; border:1px solid #ccc; border-radius:0.25rem; font-size:0.85rem; }
    button.primary { background:#22c55e; color:white; border:none; font-weight:bold; cursor:pointer; }
    button.primary:hover { background:#16a34a; }
    .history-item { margin-bottom:0.5rem; font-size:0.9rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; }
    .grid .card { margin-bottom:0; }
    .card img { width:100%; object-fit:cover; margin-bottom:0.5rem; border-radius:0.25rem; }
    .card.list { display:flex; align-items:center; gap:0.5rem; }
    .card.list img { width:50px; height:75px; margin-bottom:0; }
    .card.list .details { flex:1; }
    .reading-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:0.5rem; }
    .reading-card { display:flex; flex-direction:column; align-items:center; text-align:center; cursor:pointer; }
    .reading-card img { width:100%; height:160px; object-fit:cover; border-radius:0.25rem; }
    .cover-placeholder { width:100%; height:160px; background:rgba(0,0,0,0.2); color:#fff; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; padding:0.25rem; text-align:center; }
    .reading-card .progress-bar { width:100%; margin:0.25rem 0; }
    .reading-card .update-btn { width:100%; margin-top:0.25rem; }
    .history-layout { display:flex; gap:1rem; align-items:flex-start; }
    .history-layout img { width:120px; height:180px; object-fit:cover; border-radius:0.25rem; }
    .history-details { flex:1; }
    .view-mode-select { width:auto; padding:0.2rem; margin-bottom:0; }
    #modal-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #modal { background:var(--card-bg); padding:0.5rem; border-radius:0.25rem; width:200px; box-shadow:0 2px 8px var(--card-shadow); }
    .goal-slots { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:1rem; }
    .goal-slot { width:60px; height:80px; background:rgba(0,0,0,0.2); color:#fff; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; cursor:pointer; font-size:1.5rem; }
    .goal-slot.filled { background:var(--card-bg); color:var(--text-color); font-size:0.7rem; padding:0.25rem; text-align:center; }
    .goal-slot.filled img { width:100%; height:100%; object-fit:cover; border-radius:0.25rem; }
    #book-select-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #book-select { background:var(--card-bg); padding:1rem; border-radius:0.25rem; width:300px; max-height:80vh; overflow-y:auto; box-shadow:0 2px 8px var(--card-shadow); }
    #book-select input { margin-bottom:0.5rem; }
    .book-option { padding:0.3rem 0; cursor:pointer; }
    .book-option:hover { background:var(--progress-bg); }
    #slot-options-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #slot-options { background:var(--card-bg); padding:0.75rem; padding-bottom:1.8rem; border-radius:0.25rem; box-shadow:0 2px 8px var(--card-shadow); display:flex; flex-direction:column; align-items:flex-start; position:relative; }
    #slot-options button { background:transparent; border:none; cursor:pointer; color:var(--text-color); }
    #slot-view { font-size:1rem; margin-bottom:0.8rem; }
    #slot-remove { position:absolute; bottom:0.5rem; right:0.5rem; font-size:0.8rem; }
    #slot-options button:hover { opacity:0.7; }
    #type-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #type-editor { background:var(--card-bg); padding:0.5rem; border-radius:0.25rem; width:200px; box-shadow:0 2px 8px var(--card-shadow); }
    .goal-count { display:flex; align-items:center; gap:0.5rem; }
    .goal-count input { width:60px; margin:0; }
    .year-select { width:auto; margin-right:0.5rem; }
    .tabs { display:flex; gap:0.5rem; margin-bottom:1rem; }
    .tab { padding:0.4rem 0.8rem; background:var(--progress-bg); border:none; border-radius:0.25rem 0.25rem 0 0; cursor:pointer; }
    .tab.active { background:var(--nav-bg); color:#fff; }
    .dashboard-columns { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .dashboard-left, .dashboard-right { display:flex; flex-direction:column; gap:1rem; }
    .report-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1rem; }
    .report-grid canvas { width:100% !important; height:auto !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    <h2>üìö Biblioteca</h2>
    <button onclick="navegar('dashboard')">Dashboard</button>
    <button onclick="navegar('biblioteca')">Livros</button>
    <button onclick="navegar('adicionar')">Adicionar</button>
    <button onclick="navegar('relatorios')">Relat√≥rios</button>
    <button onclick="navegar('config')">Config</button>
    <button onclick="navegar('meta_anual')">Meta Anual</button>
    <button onclick="alternarTema()">Tema</button>
  </nav>
  <main>
    <header>
      <h1 id="tituloPagina">Dashboard</h1>
      <span id="metaAnualPaginas"></span>
      <span>üìÖ <strong id="today"></strong></span>
    </header>
    <div id="conteudo"></div>
  </main>
  <div id="modal-overlay" onclick="hideModal()">
    <div id="modal" onclick="event.stopPropagation()">
      <input type="date" id="modal-date" />
      <select id="modal-type"><option value="pages">P√°ginas</option><option value="percent">%</option></select>
      <input type="number" id="modal-value" placeholder="Valor" />
      <div id="modal-progress" style="margin:0.5rem 0;"></div>
      <button id="modal-save" class="primary">OK</button>
      <button onclick="hideModal()" style="background:transparent;color:var(--text-color);padding:0.3rem;width:100%">X</button>
    </div>
  </div>
  <div id="book-select-overlay" onclick="closeBookSelector()">
    <div id="book-select" onclick="event.stopPropagation()">
      <input type="text" id="book-search" placeholder="Buscar" />
      <div id="book-list"></div>
    </div>
  </div>
  <div id="slot-options-overlay" onclick="closeSlotOptions()">
    <div id="slot-options" onclick="event.stopPropagation()">
      <button id="slot-view" title="Exibir">Exibir</button>
      <button id="slot-remove" title="Remover">üóëÔ∏è</button>
    </div>
  </div>
  <div id="type-overlay" onclick="closeTypeEditor()">
    <div id="type-editor" onclick="event.stopPropagation()">
      <select id="type-select">
        <option value="" disabled selected>Tipo</option>
        <option value="F√≠sico">F√≠sico</option>
        <option value="E-book">E-book</option>
        <option value="Audiobook">Audiobook</option>
      </select>
      <button class="primary" onclick="saveType()">Salvar</button>
      <button onclick="closeTypeEditor()" style="background:transparent;color:var(--text-color);padding:0.3rem;width:100%">X</button>
    </div>
  </div>
  <script>
    const desafios = [
      { id:'bookmark_sprint', name:'Bookmark Sprint', description:'Ler 15 p√°g/dia', pagesPerDay:15 },
      { id:'reading_marathon', name:'Reading Marathon', description:'Ler 30 p√°g/dia', pagesPerDay:30 },
      { id:'weekend_warrior', name:'Weekend Warrior', description:'Ler 50 p√°g/dia', pagesPerDay:50 },
      { id:'annual_challenge', name:'Desafio Anual', description:'Leia 20 livros at√© o final do ano!', pagesPerDay:17 }
    ];
    let livros = JSON.parse(localStorage.getItem('livros')) || [];
    livros = livros.map(b => ({ ...b, history: b.history || [] }));
    let metaAnnual = JSON.parse(localStorage.getItem('metaAnnual')) || [];
    let metaAnnualCount = parseInt(localStorage.getItem('metaAnnualCount')) || metaAnnual.length;
    let selectingSlot = null;
    let viewMode = localStorage.getItem('viewMode') || 'list';
    const conteudo = document.getElementById('conteudo');
    document.getElementById('today').textContent = new Date().toLocaleDateString();
    let currentDate = new Date().toISOString().split('T')[0];
    if (localStorage.getItem('tema')) document.documentElement.setAttribute('data-theme', localStorage.getItem('tema'));
    document.getElementById('book-search').addEventListener('input', e => renderBookList(e.target.value));
    setInterval(() => {
      const todayStr = new Date().toISOString().split('T')[0];
      if (todayStr !== currentDate) {
        currentDate = todayStr;
        document.getElementById('today').textContent = new Date().toLocaleDateString();
        if (document.getElementById('tituloPagina').textContent === 'Dashboard') carregarDashboard();
      }
    }, 60 * 1000);
    let selectedYear = new Date().getFullYear();
    let selectedTab = 'lendo';
    let editingTypeId = null;
    let typeBack = 'biblioteca';

    function salvarLivros() { localStorage.setItem('livros', JSON.stringify(livros)); }
    function migrateBooksForNewYear() {
      const cy = new Date().getFullYear();
      livros.forEach(b => {
        b.status = b.status || (b.lidas >= b.paginas ? 'lido' : (b.lidas > 0 ? 'lendo' : 'quero_ler'));
        if (b.status === 'lido') {
          b.completedYear = b.completedYear || cy;
        } else {
          if (!b.year || b.year < cy) b.year = cy;
        }
      });
      salvarLivros();
    }
    migrateBooksForNewYear();
    function salvarMeta() {
      localStorage.setItem('metaAnnual', JSON.stringify(metaAnnual));
      localStorage.setItem('metaAnnualCount', metaAnnualCount);
    }
    function alternarTema() { const t = document.documentElement.getAttribute('data-theme'); const n = t === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('tema', n); }
    function setViewMode(m) { viewMode = m; localStorage.setItem('viewMode', m); renderBooks(); }

    function navegar(p) {
      document.getElementById('tituloPagina').textContent = p.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('metaAnualPaginas').textContent = '';
      conteudo.innerHTML = '';
      switch (p) {
        case 'dashboard': carregarDashboard(); break;
        case 'biblioteca': carregarBiblioteca(); break;
        case 'adicionar': carregarFormulario(); break;
        case 'relatorios': carregarRelatorios(); break;
        case 'config': carregarConfiguracoes(); break;
        case 'meta_anual': carregarMetaAnual(); break;
      }
    }

    let currentEditId = null;
    function showModal(id) {
      currentEditId = id;
      const book = livros.find(b => b.id === id);
      document.getElementById('modal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('modal-type').value = 'pages';
      const valueInput = document.getElementById('modal-value');
      valueInput.value = '';
      const pct = Math.round((book.lidas / book.paginas) * 100);
      document.getElementById('modal-progress').textContent = `${book.lidas}/${book.paginas} (${pct}%)`;
      document.getElementById('modal-overlay').style.display = 'flex';
      valueInput.focus();
      valueInput.select();
    }
    function hideModal() {
      document.getElementById('modal-overlay').style.display = 'none';
      currentEditId = null;
      document.getElementById('modal-progress').textContent = '';
    }

    function saveModal() {
      const date = document.getElementById('modal-date').value;
      const type = document.getElementById('modal-type').value;
      const val = parseFloat(document.getElementById('modal-value').value);
      const book = livros.find(b => b.id === currentEditId);
      if (!date || isNaN(val)) return alert('Inv√°lido');
      const old = book.lidas;
      const np = type === 'percent' ? Math.round(book.paginas * (val / 100)) : val;
      const delta = np - old;
      const pct = Math.round((np / book.paginas) * 100);
      book.lidas = Math.min(np, book.paginas);
      book.history.push({ date, pages: book.lidas, percent: pct, delta, timestamp: Date.now() });
      if (book.lidas >= book.paginas) {
        book.status = 'lido';
        book.completedYear = new Date().getFullYear();
        book.lidas = book.paginas;
      } else if (book.lidas > 0) {
        book.status = 'lendo';
        book.year = new Date().getFullYear();
      } else {
        book.status = 'quero_ler';
        book.year = new Date().getFullYear();
      }
      salvarLivros(); hideModal(); navegar('biblioteca');
    }

    document.getElementById('modal-save').addEventListener('click', saveModal);
    document.getElementById('modal-value').addEventListener('keydown', e => { if (e.key === 'Enter') saveModal(); });

    function carregarDashboard() {
      const hoje = new Date();
      const hojeStr = hoje.toISOString().split('T')[0];
      const weekAgo = new Date(hoje); weekAgo.setDate(hoje.getDate() - 6);
      const weekAgoStr = weekAgo.toISOString().split('T')[0];
      let daily = 0, weekly = 0;
      livros.forEach(b => b.history.forEach(h => {
        const pages = h.delta || 0;
        if (h.date === hojeStr) daily += pages;
        if (h.date >= weekAgoStr && h.date <= hojeStr) weekly += pages;
      }));
      const selected = livros.filter(b => metaAnnual.includes(b.id));
      const remaining = selected.reduce((sum, b) => sum + Math.max(0, b.paginas - b.lidas), 0);
      const annualPagesRead = selected.reduce((sum, b) => sum + Math.min(b.lidas, b.paginas), 0);
      const endYear = new Date(hoje.getFullYear(), 11, 31);
      const msPerDay = 1000 * 60 * 60 * 24;
      const daysLeft = Math.ceil((endYear - hoje) / msPerDay) + 1;
      const perDay = daysLeft > 0 ? Math.ceil(remaining / daysLeft) : remaining;
      document.getElementById('metaAnualPaginas').textContent = `${annualPagesRead} p√°g lidas ¬∑ ${perDay} p√°g/dia`;
      const desafioId = localStorage.getItem('desafio') || desafios[0].id;
      const d = desafios.find(x => x.id === desafioId);
      const dm = d.pagesPerDay;
      const wm = dm * 7;
      const at = metaAnnualCount;
      const ac = selected.filter(b => b.lidas >= b.paginas).length;
      const dp = Math.min(100, Math.round(daily / dm * 100));
      const wp = Math.min(100, Math.round(weekly / wm * 100));
      const ap = at > 0 ? Math.min(100, Math.round(ac / at * 100)) : 0;
      const progressCard = `
        <div class=\"card\">
          <h2>Progresso Geral</h2>
          <p>Di√°rio: ${daily}/${dm} p√°g (${dp}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${dp}%\"></div></div>
          <p>Semanal: ${weekly}/${wm} p√°g (${wp}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${wp}%\"></div></div>
          <p>Anual: ${ac}/${at} livros (${ap}%)</p>
          <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${ap}%\"></div></div>
        </div>`;
      let metaCard = '';
      let summaryCard = '';
      if (d.id === 'annual_challenge') {
        const trophy = ac >= at ? 'üèÜ Meta Anual Alcan√ßada! üèÜ' : '';
        metaCard = `
          <div class=\"card\">
            ${trophy && `<div style=\"font-size:2rem;text-align:center\">${trophy}</div>`}
            <h2>Meta di√°ria</h2>
            <p>${d.description}</p>
            <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${ap}%\"></div></div>
            <p>${ac} de ${at} livros (${ap}%)</p>
          </div>`;
        summaryCard = `
          <div class=\"card\">
            <h2>Resumo</h2>
            <p><strong>Conclu√≠dos:</strong> ${ac} livros</p>
            <p><strong>Meta anual:</strong> ${at} livros</p>
            <p><strong>Restante:</strong> ${Math.max(0, at - ac)} livros</p>
          </div>`;
      } else {
        const tp = livros.reduce((a,b) => a + b.lidas, 0);
        const rem = Math.max(0, d.pagesPerDay - tp);
        const pct = Math.min(100, Math.round(tp / d.pagesPerDay * 100));
        const trophy = pct >= 100 ? 'üèÜ Desafio Conclu√≠do! üèÜ' : '';
        metaCard = `
          <div class=\"card\">
            ${trophy && `<div style=\"font-size:2rem;text-align:center\">${trophy}</div>`}
            <h2>Meta di√°ria</h2>
            <p>${d.description}</p>
            <div class=\"progress-bar\"><div class=\"progress-fill\" style=\"width:${pct}%\"></div></div>
            <p>${pct}% meta</p>
          </div>`;
        summaryCard = `
          <div class=\"card\">
            <h2>Resumo</h2>
            <p>Total: ${tp} p√°g</p>
            <p>Meta di√°ria: ${d.pagesPerDay} p√°g</p>
            <p>Restante: ${rem} p√°g</p>
          </div>`;
      }
      const reading = livros.filter(b => b.lidas > 0 && b.lidas < b.paginas);
      let readingCard = '';
      if (reading.length) {
        const items = reading.map(b => {
          const pc = Math.round((b.lidas / b.paginas) * 100);
          const cover = b.capa
            ? `<img src=\"${b.capa}\" alt=\"Capa de ${b.titulo}\">`
            : `<div class=\"cover-placeholder\">${b.titulo}</div>`;
          return `
            <div class=\"reading-card\" onclick=\"mostrarHistorico(${b.id},'dashboard')\">
              ${cover}
              <div>${b.lidas}/${b.paginas} (${pc}%)</div>
              ${b.tipo ? `<div>${b.tipo}</div>` : ''}
              <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
              <button class="update-btn" onclick="event.stopPropagation();showModal(${b.id});">Atualizar</button>
            </div>
          `;
        }).join('');
        readingCard = `
          <div class=\"card\">
            <h2>Em leitura</h2>
            <div class=\"reading-grid\">
              ${items}
            </div>
          </div>`;
      }
      const html = `
        <div class=\"dashboard-columns\">
          <div class=\"dashboard-left\">
            ${metaCard}
            ${progressCard}
            ${summaryCard}
          </div>
          <div class=\"dashboard-right\">
            ${readingCard}
          </div>
        </div>`;
      conteudo.innerHTML = html;
    }

    function carregarMetaAnual() {
      let html = `<div class="card">
        <h2>Meta Anual</h2>
        <div class="goal-count">
          <label for="goalCount">Quantidade de livros:</label>
          <input type="number" id="goalCount" min="0" value="${metaAnnualCount}" />
        </div>
        <div id="goalSlots" class="goal-slots"></div>
      </div>`;
      conteudo.innerHTML = html;
      document.getElementById('goalCount').addEventListener('change', e => {
        metaAnnualCount = parseInt(e.target.value) || 0;
        if (metaAnnual.length > metaAnnualCount) metaAnnual = metaAnnual.slice(0, metaAnnualCount);
        salvarMeta();
        renderGoalSlots();
      });
      renderGoalSlots();
    }

    function renderGoalSlots() {
      const container = document.getElementById('goalSlots');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < metaAnnualCount; i++) {
        const slot = document.createElement('div');
        const id = metaAnnual[i];
        if (id) {
          const book = livros.find(b => b.id === id);
          slot.className = 'goal-slot filled';
          if (book && book.capa) {
            slot.innerHTML = `<img src="${book.capa}" alt="${book.titulo}">`;
            slot.style.padding = '0';
          } else {
            slot.textContent = book ? book.titulo : '';
            slot.style.padding = '';
          }
          slot.onclick = () => openSlotOptions(i);
        } else {
          slot.className = 'goal-slot';
          slot.textContent = '+';
          slot.style.padding = '';
          slot.onclick = () => openBookSelector(i);
        }
        container.appendChild(slot);
      }
    }

    function openBookSelector(i) {
      selectingSlot = i;
      document.getElementById('book-select-overlay').style.display = 'flex';
      document.getElementById('book-search').value = '';
      renderBookList('');
    }

    function closeBookSelector() {
      document.getElementById('book-select-overlay').style.display = 'none';
      selectingSlot = null;
    }

    function renderBookList(term) {
      const list = livros
        .filter(b => b.titulo.toLowerCase().includes(term.toLowerCase()))
        .filter(b => !metaAnnual.includes(b.id));
      document.getElementById('book-list').innerHTML = list.map(b => `<div class="book-option" onclick="chooseBook(${b.id})">${b.titulo}</div>`).join('');
    }

    function chooseBook(id) {
      if (selectingSlot === null) return;
      if (metaAnnual.includes(id) && metaAnnual[selectingSlot] !== id) {
        alert('Livro j√° selecionado');
        return;
      }
      metaAnnual[selectingSlot] = id;
      salvarMeta();
      renderGoalSlots();
      closeBookSelector();
    }

    function openSlotOptions(i) {
      selectingSlot = i;
      document.getElementById('slot-options-overlay').style.display = 'flex';
    }

    function closeSlotOptions() {
      document.getElementById('slot-options-overlay').style.display = 'none';
      selectingSlot = null;
    }

    document.getElementById('slot-view').addEventListener('click', () => {
      if (selectingSlot === null) return;
      const id = metaAnnual[selectingSlot];
      closeSlotOptions();
      if (id) mostrarHistorico(id, 'meta_anual');
    });

    document.getElementById('slot-remove').addEventListener('click', () => {
      if (selectingSlot === null) return;
      metaAnnual[selectingSlot] = null;
      salvarMeta();
      renderGoalSlots();
      closeSlotOptions();
    });

    function carregarBiblioteca() {
      conteudo.innerHTML = '';
      if (!livros.length) { conteudo.innerHTML = '<p>Nenhum livro.</p>'; return; }
      const top = document.createElement('div');
      top.style = 'margin-bottom:1rem; display:flex; justify-content:space-between; align-items:center;';
      top.innerHTML = `
        <select id="yearSelect" class="year-select" onchange="changeYear(this.value)"></select>
        <select class="view-mode-select" onchange="setViewMode(this.value)">
          <option value="list" ${viewMode==='list'?'selected':''}>Lista</option>
          <option value="grid" ${viewMode==='grid'?'selected':''}>Grade</option>
        </select>`;
      conteudo.appendChild(top);
      const tabsDiv = document.createElement('div');
      tabsDiv.id = 'tabsContainer';
      conteudo.appendChild(tabsDiv);
      const booksDiv = document.createElement('div');
      booksDiv.id = 'booksContainer';
      conteudo.appendChild(booksDiv);
      populateYearSelect();
      renderTabs();
      renderBooks();
    }

    function populateYearSelect() {
      const sel = document.getElementById('yearSelect');
      const cy = new Date().getFullYear();
      let opts = '<option value="all">Todos</option>';
      for (let y = cy; y >= 2020; y--) {
        opts += `<option value="${y}" ${selectedYear===y?'selected':''}>${y}</option>`;
      }
      sel.innerHTML = opts;
    }

    function changeYear(val) {
      selectedYear = val === 'all' ? 'all' : parseInt(val);
      if (selectedYear === new Date().getFullYear()) selectedTab = 'lendo';
      renderTabs();
      renderBooks();
    }

    function renderTabs() {
      const cy = new Date().getFullYear();
      const tabsDiv = document.getElementById('tabsContainer');
      if (selectedYear !== cy) { tabsDiv.innerHTML = ''; return; }
      tabsDiv.className = 'tabs';
      tabsDiv.innerHTML = `
        <button class="tab ${selectedTab==='lendo'?'active':''}" onclick="setTab('lendo')">Lendo</button>
        <button class="tab ${selectedTab==='quero'?'active':''}" onclick="setTab('quero')">Quero ler</button>
        <button class="tab ${selectedTab==='lido'?'active':''}" onclick="setTab('lido')">Lido</button>
      `;
    }

    function setTab(t) { selectedTab = t; renderTabs(); renderBooks(); }

    function renderBooks() {
      const container = document.getElementById('booksContainer');
      if (!container) return;
      container.innerHTML = '';
      if (viewMode === 'grid') container.className = 'grid'; else container.className = '';
      let list = [];
      const cy = new Date().getFullYear();
      if (selectedYear === 'all') {
        list = livros.filter(b => b.status === 'lido');
      } else if (selectedYear === cy) {
        if (selectedTab === 'lendo') list = livros.filter(b => b.status==='lendo' && b.year===cy);
        else if (selectedTab === 'quero') list = livros.filter(b => b.status==='quero_ler' && b.year===cy);
        else list = livros.filter(b => b.status==='lido' && b.completedYear===cy);
      } else {
        list = livros.filter(b => b.status==='lido' && b.completedYear===selectedYear);
      }
      if (!list.length) { container.innerHTML = '<p>Nenhum livro.</p>'; return; }
      list.forEach(b => {
        const pc = Math.round((b.lidas/b.paginas)*100);
        const div = document.createElement('div');
        div.className = 'card';
        if (viewMode === 'list') div.classList.add('list');
        div.onclick = () => mostrarHistorico(b.id);
        const cover = b.capa ? `<img src="${b.capa}" alt="Capa de ${b.titulo}">` : '';
        const tipo = b.tipo
          ? `<p>Tipo: ${b.tipo}</p>`
          : `<button class="update-btn" onclick="event.stopPropagation();editarTipo(${b.id});">Definir tipo</button>`;
        div.innerHTML = `
          ${cover}
          <div class="details">
            <h3>${b.titulo}</h3>
            <p>${b.lidas}/${b.paginas} (${pc}%)</p>
            <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
            ${tipo}
            <button class="update-btn" onclick="event.stopPropagation();showModal(${b.id});">Atualizar progresso</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function mostrarHistorico(id, back='biblioteca') {
      const book = livros.find(b => b.id === id);
      document.getElementById('tituloPagina').textContent = 'Hist√≥rico';
      const cover = book.capa ? `<img src="${book.capa}" alt="Capa de ${book.titulo}">` : '';
      let html = `
        <div class="card">
          <button onclick="navegar('${back}')" style="background:transparent;color:var(--text-color);border:none;margin-bottom:1rem">‚óÄ Voltar</button>
          <div class="history-layout">
            ${cover}
            <div class="history-details">
              <h2>Hist√≥rico: ${book.titulo}</h2>
              ${book.tipo ? `<p><strong>Tipo:</strong> ${book.tipo}</p>` : ''}
      `;
      const sorted = book.history.slice().sort((a,b) => b.timestamp - a.timestamp);
      if (!sorted.length) html += '<p>Nenhum progresso registrado.</p>';
      else sorted.forEach(h => html += `<div class="history-item">${h.date}: ${h.pages} p√°g (${h.percent}%)</div>`);
      html += `<button class="update-btn" onclick="showModal(${id});event.stopPropagation();">Atualizar progresso</button>`;
      html += `<button class="update-btn" onclick="editarCapa(${id});event.stopPropagation();">${book.capa ? 'Editar capa' : 'Adicionar capa'}</button>`;
      html += `<button class="update-btn" onclick="event.stopPropagation();editarTipo(${id}, '${back}');">${book.tipo ? 'Editar tipo' : 'Adicionar tipo'}</button>`;
      html += `
            </div>
          </div>
        </div>`;
      conteudo.innerHTML = html;
    }

    function carregarFormulario() {
      conteudo.innerHTML = `
        <div class="card">
          <h2>Adicionar Livro</h2>
          <input id="titulo" placeholder="T√≠tulo" />
          <input id="capa" placeholder="URL da capa" />
          <input id="paginas" type="number" placeholder="P√°ginas" />
          <input id="lidas" type="number" placeholder="Lidas" />
          <select id="tipo">
            <option value="" disabled selected>Tipo</option>
            <option value="F√≠sico">F√≠sico</option>
            <option value="E-book">E-book</option>
            <option value="Audiobook">Audiobook</option>
          </select>
          <button class="primary" onclick="adicionarLivro()">Salvar</button>
        </div>`;
    }

    function carregarRelatorios() {
      const statusCounts = { quero_ler:0, lendo:0, lido:0 };
      livros.forEach(b => { statusCounts[b.status] = (statusCounts[b.status] || 0) + 1; });

      const typeCounts = {};
      livros.forEach(b => { const t = b.tipo || 'Sem tipo'; typeCounts[t] = (typeCounts[t] || 0) + 1; });

      const historyByMonth = {};
      livros.forEach(b => b.history.forEach(h => {
        const m = h.date.slice(0,7);
        historyByMonth[m] = (historyByMonth[m] || 0) + h.delta;
      }));
      const months = Object.keys(historyByMonth).sort();
      const pagesData = months.map(m => historyByMonth[m]);
      const labels = months.map(m => { const [y,mo] = m.split('-'); return `${mo}/${y}`; });

      conteudo.innerHTML = `
        <div class="card">
          <h2>Relat√≥rios</h2>
          <div class="report-grid">
            <canvas id="statusChart"></canvas>
            <canvas id="typeChart"></canvas>
            <canvas id="pagesChart" style="grid-column:1/-1"></canvas>
          </div>
        </div>`;

      const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
      Chart.defaults.color = baseColor;

      new Chart(document.getElementById('statusChart'), {
        type:'doughnut',
        data:{
          labels:['Quero ler','Lendo','Lido'],
          datasets:[{ data:[statusCounts.quero_ler, statusCounts.lendo, statusCounts.lido], backgroundColor:['#f59e0b','#3b82f6','#22c55e'] }]
        }
      });

      new Chart(document.getElementById('typeChart'), {
        type:'bar',
        data:{
          labels:Object.keys(typeCounts),
          datasets:[{ data:Object.values(typeCounts), backgroundColor:'#3b82f6' }]
        },
        options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });

      new Chart(document.getElementById('pagesChart'), {
        type:'line',
        data:{
          labels,
          datasets:[{ label:'P√°ginas lidas', data:pagesData, borderColor:'#22c55e', tension:0.3 }]
        },
        options:{ scales:{ y:{ beginAtZero:true } } }
      });
    }

    function carregarConfiguracoes() {
      const idSel = localStorage.getItem('desafio') || desafios[0].id;
      const opts = desafios.map(d => `<option value="${d.id}"${d.id===idSel?' selected':''}>${d.name}</option>`).join('');
      conteudo.innerHTML = `<div class="card">
        <h2>Configura√ß√µes</h2>
        <select onchange="localStorage.setItem('desafio',this.value); navegar('dashboard')">
          ${opts}
        </select>
        <button class="primary" onclick="reiniciarBaseDados()">Reiniciar base de Dados</button>
      </div>`;
    }

    function reiniciarBaseDados() {
      if (confirm('Deseja realmente apagar todos os dados?')) {
        localStorage.clear();
        livros = [];
        metaAnnual = [];
        metaAnnualCount = 0;
        viewMode = 'list';
        document.documentElement.setAttribute('data-theme', 'light');
        navegar('dashboard');
      }
    }

    function adicionarLivro() {
      const t = document.getElementById('titulo').value;
      const c = document.getElementById('capa').value;
      const pg = parseInt(document.getElementById('paginas').value);
      const ld = parseInt(document.getElementById('lidas').value);
      const tp = document.getElementById('tipo').value;
      if (!t || !pg || isNaN(ld) || !tp) return alert('Preencha todos os campos!');
      const cy = new Date().getFullYear();
      let status = 'quero_ler', year = cy, completedYear = null;
      if (ld >= pg) { status = 'lido'; completedYear = cy; }
      else if (ld > 0) { status = 'lendo'; }
      const book = { id: Date.now(), titulo: t, paginas: pg, lidas: ld, capa: c, tipo: tp, history: [], status, year, completedYear };
      if (ld > 0) {
        const date = new Date().toISOString().split('T')[0];
        const pct  = Math.round((ld/pg)*100);
        book.history.push({ date, pages: ld, percent: pct, delta: ld, timestamp: Date.now() });
      }
      livros.push(book);
      salvarLivros();
      navegar('biblioteca');
    }

    function editarCapa(id) {
      const book = livros.find(b => b.id === id);
      const url = prompt('URL da capa', book.capa || '');
      if (url !== null) {
        book.capa = url.trim();
        salvarLivros();
        navegar('biblioteca');
      }
    }

    function editarTipo(id, back = 'biblioteca') {
      editingTypeId = id;
      typeBack = back;
      const book = livros.find(b => b.id === id);
      const select = document.getElementById('type-select');
      select.value = book.tipo || '';
      document.getElementById('type-overlay').style.display = 'flex';
    }

    function saveType() {
      const tp = document.getElementById('type-select').value;
      if (!tp) { alert('Selecione um tipo'); return; }
      const book = livros.find(b => b.id === editingTypeId);
      book.tipo = tp;
      salvarLivros();
      closeTypeEditor();
      navegar(typeBack);
    }

    function closeTypeEditor() {
      document.getElementById('type-overlay').style.display = 'none';
      document.getElementById('type-select').value = '';
      editingTypeId = null;
      typeBack = 'biblioteca';
    }

    navegar('dashboard');
  </script>
</body>
</html>
