<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Biblioteca Pessoal</title>
  <style>
    :root { --bg-color:#f0fdf4; --text-color:#333; --nav-bg:#22c55e; --card-bg:white; --card-shadow:rgba(0,0,0,0.06); --progress-bg:#e5e7eb; --progress-fill:#22c55e; }
    [data-theme="dark"] { --bg-color:#111827; --text-color:#e5e7eb; --nav-bg:#1f2937; --card-bg:#1e293b; --card-shadow:rgba(0,0,0,0.4); --progress-bg:#374151; --progress-fill:#10b981; }
    * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI',sans-serif; }
    body { display:grid; grid-template-columns:240px 1fr; height:100vh; background:var(--bg-color); color:var(--text-color); }
    nav { background:var(--nav-bg); padding:1rem; color:white; }
    nav h2 { font-size:1.2rem; margin-bottom:1rem; }
    nav button { width:100%; background:transparent; border:none; color:inherit; padding:0.5rem; text-align:left; cursor:pointer; border-radius:0.25rem; }
    nav button:hover { background:rgba(255,255,255,0.2); }
    main { padding:1rem; overflow-y:auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); padding:0.5rem 1rem; border-radius:0.5rem; box-shadow:0 2px 8px var(--card-shadow); margin-bottom:1rem; }
    header h1 { font-size:1.2rem; }
    .card { background:var(--card-bg); padding:1rem; border-radius:0.5rem; box-shadow:0 4px 12px var(--card-shadow); margin-bottom:1rem; cursor:default; }
    .progress-bar { background:var(--progress-bg); height:8px; border-radius:4px; overflow:hidden; margin:0.25rem 0; }
    .progress-fill { height:100%; background:var(--progress-fill); width:0%; }
    .update-btn { background:#e0e0e0; color:var(--text-color); border:none; border-radius:0.25rem; padding:0.4rem 0.6rem; font-size:0.85rem; cursor:pointer; margin-top:0.5rem; width:150px; white-space:nowrap; text-align:center; }
    input, select, button { padding:0.4rem; margin-bottom:0.5rem; width:100%; border:1px solid #ccc; border-radius:0.25rem; font-size:0.85rem; }
    button.primary { background:#22c55e; color:white; border:none; font-weight:bold; cursor:pointer; }
    button.primary:hover { background:#16a34a; }
    .history-item { margin-bottom:0.5rem; font-size:0.9rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; }
    .grid .card { margin-bottom:0; }
    .card img { width:100%; object-fit:cover; margin-bottom:0.5rem; border-radius:0.25rem; }
    .card.list { display:flex; align-items:center; gap:0.5rem; }
    .card.list img { width:50px; height:75px; margin-bottom:0; }
    .card.list .details { flex:1; }
    .reading-item { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
    .reading-item img { width:40px; height:60px; object-fit:cover; border-radius:0.25rem; }
    .reading-item .info { flex:1; }
    .reading-item .update-btn { margin-top:0; width:auto; }
    .view-mode-select { width:auto; padding:0.2rem; margin-bottom:0; }
    #modal-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #modal { background:var(--card-bg); padding:0.5rem; border-radius:0.25rem; width:200px; box-shadow:0 2px 8px var(--card-shadow); }
    .goal-slots { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:1rem; }
    .goal-slot { width:60px; height:80px; background:rgba(0,0,0,0.2); color:#fff; display:flex; align-items:center; justify-content:center; border-radius:0.25rem; cursor:pointer; font-size:1.5rem; }
    .goal-slot.filled { background:var(--card-bg); color:var(--text-color); font-size:0.7rem; padding:0.25rem; text-align:center; }
    .goal-slot.filled img { width:100%; height:100%; object-fit:cover; border-radius:0.25rem; }
    #book-select-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #book-select { background:var(--card-bg); padding:1rem; border-radius:0.25rem; width:300px; max-height:80vh; overflow-y:auto; box-shadow:0 2px 8px var(--card-shadow); }
    #book-select input { margin-bottom:0.5rem; }
    .book-option { padding:0.3rem 0; cursor:pointer; }
    .book-option:hover { background:var(--progress-bg); }
    #slot-options-overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
    #slot-options { background:var(--card-bg); padding:0.75rem; padding-bottom:1.8rem; border-radius:0.25rem; box-shadow:0 2px 8px var(--card-shadow); display:flex; flex-direction:column; align-items:flex-start; position:relative; }
    #slot-options button { background:transparent; border:none; cursor:pointer; color:var(--text-color); }
    #slot-view { font-size:1rem; margin-bottom:0.8rem; }
    #slot-remove { position:absolute; bottom:0.5rem; right:0.5rem; font-size:0.8rem; }
    #slot-options button:hover { opacity:0.7; }
    .goal-count { display:flex; align-items:center; gap:0.5rem; }
    .goal-count input { width:60px; margin:0; }
  </style>
</head>
<body>
  <nav>
    <h2>üìö Biblioteca</h2>
    <button onclick="navegar('dashboard')">Dashboard</button>
    <button onclick="navegar('biblioteca')">Livros</button>
    <button onclick="navegar('adicionar')">Adicionar</button>
    <button onclick="navegar('relatorios')">Relat√≥rios</button>
    <button onclick="navegar('config')">Config</button>
    <button onclick="navegar('meta_anual')">Meta Anual</button>
    <button onclick="alternarTema()">Tema</button>
  </nav>
  <main>
    <header>
      <h1 id="tituloPagina">Dashboard</h1>
      <span id="metaAnualPaginas"></span>
      <span>üìÖ <strong id="today"></strong></span>
    </header>
    <div id="conteudo"></div>
  </main>
  <div id="modal-overlay" onclick="hideModal()">
    <div id="modal" onclick="event.stopPropagation()">
      <input type="date" id="modal-date" />
      <select id="modal-type"><option value="pages">P√°ginas</option><option value="percent">%</option></select>
      <input type="number" id="modal-value" placeholder="Valor" />
      <button id="modal-save" class="primary">OK</button>
      <button onclick="hideModal()" style="background:transparent;color:var(--text-color);padding:0.3rem;width:100%">X</button>
    </div>
  </div>
  <div id="book-select-overlay" onclick="closeBookSelector()">
    <div id="book-select" onclick="event.stopPropagation()">
      <input type="text" id="book-search" placeholder="Buscar" />
      <div id="book-list"></div>
    </div>
  </div>
  <div id="slot-options-overlay" onclick="closeSlotOptions()">
    <div id="slot-options" onclick="event.stopPropagation()">
      <button id="slot-view" title="Exibir">Exibir</button>
      <button id="slot-remove" title="Remover">üóëÔ∏è</button>
    </div>
  </div>
  <script>
    const desafios = [
      { id:'bookmark_sprint', name:'Bookmark Sprint', description:'Ler 15 p√°g/dia', pagesPerDay:15 },
      { id:'reading_marathon', name:'Reading Marathon', description:'Ler 30 p√°g/dia', pagesPerDay:30 },
      { id:'weekend_warrior', name:'Weekend Warrior', description:'Ler 50 p√°g/dia', pagesPerDay:50 },
      { id:'annual_challenge', name:'Desafio Anual', description:'Leia 20 livros at√© o final do ano!', pagesPerDay:17 }
    ];
    let livros = JSON.parse(localStorage.getItem('livros')) || [];
    livros = livros.map(b => ({ ...b, history: b.history || [] }));
    let metaAnnual = JSON.parse(localStorage.getItem('metaAnnual')) || [];
    let metaAnnualCount = parseInt(localStorage.getItem('metaAnnualCount')) || metaAnnual.length;
    let selectingSlot = null;
    let viewMode = localStorage.getItem('viewMode') || 'list';
    const conteudo = document.getElementById('conteudo');
    document.getElementById('today').textContent = new Date().toLocaleDateString();
    if (localStorage.getItem('tema')) document.documentElement.setAttribute('data-theme', localStorage.getItem('tema'));
    document.getElementById('book-search').addEventListener('input', e => renderBookList(e.target.value));

    function salvarLivros() { localStorage.setItem('livros', JSON.stringify(livros)); }
    function salvarMeta() {
      localStorage.setItem('metaAnnual', JSON.stringify(metaAnnual));
      localStorage.setItem('metaAnnualCount', metaAnnualCount);
    }
    function alternarTema() { const t = document.documentElement.getAttribute('data-theme'); const n = t === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('tema', n); }
    function setViewMode(m) { viewMode = m; localStorage.setItem('viewMode', m); carregarBiblioteca(); }

    function navegar(p) {
      document.getElementById('tituloPagina').textContent = p.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('metaAnualPaginas').textContent = '';
      conteudo.innerHTML = '';
      switch (p) {
        case 'dashboard': carregarDashboard(); break;
        case 'biblioteca': carregarBiblioteca(); break;
        case 'adicionar': carregarFormulario(); break;
        case 'relatorios': carregarRelatorios(); break;
        case 'config': carregarConfiguracoes(); break;
        case 'meta_anual': carregarMetaAnual(); break;
      }
    }

    let currentEditId = null;
    function showModal(id) {
      currentEditId = id;
      document.getElementById('modal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('modal-type').value = 'pages';
      document.getElementById('modal-value').value = '';
      document.getElementById('modal-overlay').style.display = 'flex';
    }
    function hideModal() { document.getElementById('modal-overlay').style.display = 'none'; currentEditId = null; }

    document.getElementById('modal-save').addEventListener('click', () => {
      const date = document.getElementById('modal-date').value;
      const type = document.getElementById('modal-type').value;
      const val = parseFloat(document.getElementById('modal-value').value);
      const book = livros.find(b => b.id === currentEditId);
      if (!date || isNaN(val)) return alert('Inv√°lido');
      const old = book.lidas;
      const np = type === 'percent' ? Math.round(book.paginas * (val / 100)) : val;
      const delta = np - old;
      const pct = Math.round((np / book.paginas) * 100);
      book.lidas = np;
      book.history.push({ date, pages: np, percent: pct, delta, timestamp: Date.now() });
      salvarLivros(); hideModal(); navegar('biblioteca');
    });

    function carregarDashboard() {
      const hoje = new Date();
      const hojeStr = hoje.toISOString().split('T')[0];
      const weekAgo = new Date(hoje); weekAgo.setDate(hoje.getDate() - 6);
      const weekAgoStr = weekAgo.toISOString().split('T')[0];
      let daily = 0, weekly = 0;
      livros.forEach(b => b.history.forEach(h => {
        const pages = h.delta || 0;
        if (h.date === hojeStr) daily += pages;
        if (h.date >= weekAgoStr && h.date <= hojeStr) weekly += pages;
      }));
      const selected = livros.filter(b => metaAnnual.includes(b.id));
      const remaining = selected.reduce((sum, b) => sum + Math.max(0, b.paginas - b.lidas), 0);
      const annualPagesRead = selected.reduce((sum, b) => sum + Math.min(b.lidas, b.paginas), 0);
      const endYear = new Date(hoje.getFullYear(), 11, 31);
      const msPerDay = 1000 * 60 * 60 * 24;
      const daysLeft = Math.ceil((endYear - hoje) / msPerDay) + 1;
      const perDay = daysLeft > 0 ? Math.ceil(remaining / daysLeft) : remaining;
      document.getElementById('metaAnualPaginas').textContent = `${annualPagesRead} p√°g lidas ¬∑ ${perDay} p√°g/dia`;
      const desafioId = localStorage.getItem('desafio') || desafios[0].id;
      const d = desafios.find(x => x.id === desafioId);
      const dm = d.pagesPerDay;
      const wm = dm * 7;
      const at = 20;
      const ac = livros.filter(b => b.lidas >= b.paginas).length;
      const dp = Math.min(100, Math.round(daily / dm * 100));
      const wp = Math.min(100, Math.round(weekly / wm * 100));
      const ap = Math.min(100, Math.round(ac / at * 100));
      let html = `
        <div class="card">
          <h2>Progresso Geral</h2>
          <p>Di√°rio: ${daily}/${dm} p√°g (${dp}%)</p>
          <div class="progress-bar"><div class="progress-fill" style="width:${dp}%"></div></div>
          <p>Semanal: ${weekly}/${wm} p√°g (${wp}%)</p>
          <div class="progress-bar"><div class="progress-fill" style="width:${wp}%"></div></div>
          <p>Anual: ${ac}/${at} livros (${ap}%)</p>
          <div class="progress-bar"><div class="progress-fill" style="width:${ap}%"></div></div>
        </div>`;
      if (d.id === 'annual_challenge') {
        const trophy = ac >= at ? 'üèÜ Meta Anual Alcan√ßada! üèÜ' : '';
        html += `
          <div class="card">
            ${trophy && `<div style="font-size:2rem;text-align:center">${trophy}</div>`}
            <h2>${d.name}</h2>
            <p>${d.description}</p>
            <div class="progress-bar"><div class="progress-fill" style="width:${ap}%"></div></div>
            <p>${ac} de ${at} livros (${ap}%)</p>
          </div>
          <div class="card">
            <h2>Resumo</h2>
            <p><strong>Conclu√≠dos:</strong> ${ac} livros</p>
            <p><strong>Meta anual:</strong> ${at} livros</p>
            <p><strong>Restante:</strong> ${Math.max(0, at - ac)} livros</p>
          </div>`;
      } else {
        const tp = livros.reduce((a,b) => a + b.lidas, 0);
        const rem = Math.max(0, d.pagesPerDay - tp);
        const pct = Math.min(100, Math.round(tp / d.pagesPerDay * 100));
        const trophy = pct >= 100 ? 'üèÜ Desafio Conclu√≠do! üèÜ' : '';
        html += `
          <div class="card">
            ${trophy && `<div style="font-size:2rem;text-align:center">${trophy}</div>`}
            <h2>${d.name}</h2>
            <p>${d.description}</p>
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <p>${pct}% meta</p>
          </div>
          <div class="card">
            <h2>Resumo</h2>
            <p>Total: ${tp} p√°g</p>
            <p>Meta di√°ria: ${d.pagesPerDay} p√°g</p>
            <p>Restante: ${rem} p√°g</p>
          </div>`;
      }
      const reading = livros.filter(b => b.lidas > 0 && b.lidas < b.paginas);
      if (reading.length) {
        const items = reading.map(b => {
          const pc = Math.round((b.lidas / b.paginas) * 100);
          const cover = b.capa ? `<img src="${b.capa}" alt="Capa de ${b.titulo}">` : '';
          return `
            <div class="reading-item">
              ${cover}
              <div class="info">
                <strong>${b.titulo}</strong>
                <div>${b.lidas}/${b.paginas} p√°g (${pc}%)</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
              </div>
              <button class="update-btn" onclick="showModal(${b.id});">Atualizar</button>
            </div>
          `;
        }).join('');
        html += `
          <div class="card">
            <h2>Em leitura</h2>
            ${items}
          </div>`;
      }
      conteudo.innerHTML = html;
    }

    function carregarMetaAnual() {
      let html = `<div class="card">
        <h2>Meta Anual</h2>
        <div class="goal-count">
          <label for="goalCount">Quantidade de livros:</label>
          <input type="number" id="goalCount" min="0" value="${metaAnnualCount}" />
        </div>
        <div id="goalSlots" class="goal-slots"></div>
      </div>`;
      conteudo.innerHTML = html;
      document.getElementById('goalCount').addEventListener('change', e => {
        metaAnnualCount = parseInt(e.target.value) || 0;
        if (metaAnnual.length > metaAnnualCount) metaAnnual = metaAnnual.slice(0, metaAnnualCount);
        salvarMeta();
        renderGoalSlots();
      });
      renderGoalSlots();
    }

    function renderGoalSlots() {
      const container = document.getElementById('goalSlots');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < metaAnnualCount; i++) {
        const slot = document.createElement('div');
        const id = metaAnnual[i];
        if (id) {
          const book = livros.find(b => b.id === id);
          slot.className = 'goal-slot filled';
          if (book && book.capa) {
            slot.innerHTML = `<img src="${book.capa}" alt="${book.titulo}">`;
            slot.style.padding = '0';
          } else {
            slot.textContent = book ? book.titulo : '';
            slot.style.padding = '';
          }
          slot.onclick = () => openSlotOptions(i);
        } else {
          slot.className = 'goal-slot';
          slot.textContent = '+';
          slot.style.padding = '';
          slot.onclick = () => openBookSelector(i);
        }
        container.appendChild(slot);
      }
    }

    function openBookSelector(i) {
      selectingSlot = i;
      document.getElementById('book-select-overlay').style.display = 'flex';
      document.getElementById('book-search').value = '';
      renderBookList('');
    }

    function closeBookSelector() {
      document.getElementById('book-select-overlay').style.display = 'none';
      selectingSlot = null;
    }

    function renderBookList(term) {
      const list = livros.filter(b => b.titulo.toLowerCase().includes(term.toLowerCase()));
      document.getElementById('book-list').innerHTML = list.map(b => `<div class="book-option" onclick="chooseBook(${b.id})">${b.titulo}</div>`).join('');
    }

    function chooseBook(id) {
      if (selectingSlot === null) return;
      if (metaAnnual.includes(id) && metaAnnual[selectingSlot] !== id) {
        alert('Livro j√° selecionado');
        return;
      }
      metaAnnual[selectingSlot] = id;
      salvarMeta();
      renderGoalSlots();
      closeBookSelector();
    }

    function openSlotOptions(i) {
      selectingSlot = i;
      document.getElementById('slot-options-overlay').style.display = 'flex';
    }

    function closeSlotOptions() {
      document.getElementById('slot-options-overlay').style.display = 'none';
      selectingSlot = null;
    }

    document.getElementById('slot-view').addEventListener('click', () => {
      if (selectingSlot === null) return;
      const id = metaAnnual[selectingSlot];
      closeSlotOptions();
      if (id) mostrarHistorico(id, 'meta_anual');
    });

    document.getElementById('slot-remove').addEventListener('click', () => {
      if (selectingSlot === null) return;
      metaAnnual[selectingSlot] = null;
      salvarMeta();
      renderGoalSlots();
      closeSlotOptions();
    });

    function carregarBiblioteca() {
      if (!livros.length) { conteudo.innerHTML = '<p>Nenhum livro.</p>'; return; }
      conteudo.innerHTML = `
        <div style="margin-bottom:1rem; display:flex; justify-content:flex-end;">
          <select class="view-mode-select" onchange="setViewMode(this.value)">
            <option value="list" ${viewMode==='list'?'selected':''}>Lista</option>
            <option value="grid" ${viewMode==='grid'?'selected':''}>Grade</option>
          </select>
        </div>
      `;
      const container = document.createElement('div');
      if (viewMode === 'grid') container.className = 'grid';
      const pend = livros.filter(b => b.lidas < b.paginas);
      const done = livros.filter(b => b.lidas >= b.paginas)
        .sort((a,b) => b.history[b.history.length-1].timestamp - a.history[a.history.length-1].timestamp);
      pend.concat(done).forEach(b => {
        const pc = Math.round((b.lidas/b.paginas)*100);
        const div = document.createElement('div');
        div.className = 'card';
        if (viewMode === 'list') div.classList.add('list');
        div.onclick = () => mostrarHistorico(b.id);
        const cover = b.capa ? `<img src="${b.capa}" alt="Capa de ${b.titulo}">` : '';
        div.innerHTML = `
          ${cover}
          <div class="details">
            <h3>${b.titulo}</h3>
            <p>${b.lidas}/${b.paginas} (${pc}%)</p>
            <div class="progress-bar"><div class="progress-fill" style="width:${pc}%"></div></div>
            <button class="update-btn" onclick="event.stopPropagation();showModal(${b.id});">Atualizar progresso</button>
            <button class="update-btn" onclick="event.stopPropagation();editarCapa(${b.id});">${b.capa ? 'Editar capa' : 'Adicionar capa'}</button>
          </div>
        `;
        container.appendChild(div);
      });
      conteudo.appendChild(container);
    }

    function mostrarHistorico(id, back='biblioteca') {
      const book = livros.find(b => b.id === id);
      document.getElementById('tituloPagina').textContent = 'Hist√≥rico';
      let html = `
        <div class="card">
          <button onclick="navegar('${back}')" style="background:transparent;color:var(--text-color);border:none;margin-bottom:1rem">‚óÄ Voltar</button>
          <h2>Hist√≥rico: ${book.titulo}</h2>
      `;
      const sorted = book.history.slice().sort((a,b) => b.timestamp - a.timestamp);
      if (!sorted.length) html += '<p>Nenhum progresso registrado.</p>';
      else sorted.forEach(h => html += `<div class="history-item">${h.date}: ${h.pages} p√°g (${h.percent}%)</div>`);
      html += `<button class="update-btn" onclick="showModal(${id});event.stopPropagation();">Atualizar progresso</button>`;
      html += `<button class="update-btn" onclick="editarCapa(${id});event.stopPropagation();">${book.capa ? 'Editar capa' : 'Adicionar capa'}</button>`;
      html += `</div>`;
      conteudo.innerHTML = html;
    }

    function carregarFormulario() {
      conteudo.innerHTML = `
        <div class="card">
          <h2>Adicionar Livro</h2>
          <input id="titulo" placeholder="T√≠tulo" />
          <input id="capa" placeholder="URL da capa" />
          <input id="paginas" type="number" placeholder="P√°ginas" />
          <input id="lidas" type="number" placeholder="Lidas" />
          <button class="primary" onclick="adicionarLivro()">Salvar</button>
        </div>`;
    }

    function carregarRelatorios() {
      conteudo.innerHTML = `<div class="card"><h2>Relat√≥rios</h2><p>Em breve</p></div>`;
    }

    function carregarConfiguracoes() {
      const idSel = localStorage.getItem('desafio') || desafios[0].id;
      const opts = desafios.map(d => `<option value="${d.id}"${d.id===idSel?' selected':''}>${d.name}</option>`).join('');
      conteudo.innerHTML = `<div class="card">
        <h2>Configura√ß√µes</h2>
        <select onchange="localStorage.setItem('desafio',this.value); navegar('dashboard')">
          ${opts}
        </select>
      </div>`;
    }

    function adicionarLivro() {
      const t = document.getElementById('titulo').value;
      const c = document.getElementById('capa').value;
      const pg = parseInt(document.getElementById('paginas').value);
      const ld = parseInt(document.getElementById('lidas').value);
      if (!t || !pg || isNaN(ld)) return alert('Preencha todos os campos!');
      const book = { id: Date.now(), titulo: t, paginas: pg, lidas: ld, capa: c, history: [] };
      if (ld > 0) {
        const date = new Date().toISOString().split('T')[0];
        const pct  = Math.round((ld/pg)*100);
        book.history.push({ date, pages: ld, percent: pct, delta: ld, timestamp: Date.now() });
      }
      livros.push(book);
      salvarLivros();
      navegar('biblioteca');
    }

    function editarCapa(id) {
      const book = livros.find(b => b.id === id);
      const url = prompt('URL da capa', book.capa || '');
      if (url !== null) {
        book.capa = url.trim();
        salvarLivros();
        navegar('biblioteca');
      }
    }

    navegar('dashboard');
  </script>
</body>
</html>
